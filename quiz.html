<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Avalia√ß√£o da Aula</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Outfit:wght@300;400;600&display=swap');
    .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    .option-card { transition: all 0.2s ease; border: 2px solid transparent; }
    .option-card:hover { border-color: #3B82F6; background: #EFF6FF; }
    .option-card.selected { border-color: #2563EB; background: #DBEAFE; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen font-['Outfit']">

  <div id="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-white">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
  </div>

  <div class="max-w-2xl mx-auto px-4 py-8">
    <div id="quiz-container" class="hidden">
      <div class="mb-8 text-center">
        <h1 id="lesson-title" class="text-2xl font-bold text-slate-800 font-['Nunito'] mb-2">Avalia√ß√£o</h1>
        <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
          <div id="progress-bar" class="bg-blue-600 h-full w-0 transition-all duration-500"></div>
        </div>
        <p id="step-indicator" class="text-sm text-slate-500 mt-2 font-medium">Pergunta 1 de 5</p>
      </div>

      <div class="glass-card rounded-3xl p-8 shadow-xl border border-white mb-6">
        <div id="question-content">
          <h2 id="question-text" class="text-xl text-slate-800 font-semibold mb-6">Carregando pergunta...</h2>
          <div id="options-container" class="space-y-3">
            </div>
        </div>
      </div>

      <div class="flex justify-between items-center">
        <button id="btn-back" class="px-6 py-3 text-slate-600 font-semibold hover:bg-slate-100 rounded-xl transition invisible">Voltar</button>
        <button id="btn-next" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-200 hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>Avan√ßar</button>
      </div>
    </div>
  </div>

  <script type="module">
    // --- CONFIGURA√á√ÉO SUPABASE ---
    const SUPABASE_URL = 'https://hiigckoowkrpewlybfef.supabase.co';
    const SUPABASE_KEY = 'SUA_CHAVE_ANONIMA_AQUI'; // Certifique-se de que esta chave √© a correta
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- VARI√ÅVEIS DE ESTADO ---
    let questions = [];
    let currentStep = 0;
    let userAnswers = {};
    
    // Captura par√¢metros da URL
    const params = new URLSearchParams(window.location.search);
    const userId = params.get('user_id');
    const lessonId = params.get('lesson_id');
    const courseId = params.get('course_id');

    async function init() {
      if (!lessonId || !userId) {
        showError("Par√¢metros de aula ou usu√°rio ausentes na URL.");
        return;
      }

      try {
        console.log("üîç Buscando perguntas para Lesson ID:", lessonId);
        const { data, error } = await _supabase
          .from('quiz_questions')
          .select('*')
          .eq('lesson_id', lessonId)
          .order('order', { ascending: true });

        if (error) throw error;

        if (!data || data.length === 0) {
          showError("Nenhuma pergunta encontrada para esta avalia√ß√£o.");
          return;
        }

        questions = data;
        renderQuiz();
      } catch (err) {
        console.error("‚ùå Erro ao carregar quiz:", err);
        showError("Falha na comunica√ß√£o com o banco de dados.");
      } finally {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('quiz-container').classList.remove('hidden');
      }
    }

    function renderQuiz() {
      const question = questions[currentStep];
      const container = document.getElementById('options-container');
      const text = document.getElementById('question-text');
      const stepIndicator = document.getElementById('step-indicator');
      const progressBar = document.getElementById('progress-bar');
      const btnNext = document.getElementById('btn-next');
      const btnBack = document.getElementById('btn-back');

      // Atualiza interface
      text.textContent = question.question_text;
      stepIndicator.textContent = `Pergunta ${currentStep + 1} de ${questions.length}`;
      progressBar.style.width = `${((currentStep + 1) / questions.length) * 100}%`;
      
      container.innerHTML = '';
      
      // Gera op√ß√µes (A, B, C, D...)
      const options = ['a', 'b', 'c', 'd', 'e'];
      options.forEach(opt => {
        if (question[`option_${opt}`]) {
          const div = document.createElement('div');
          div.className = `option-card p-4 rounded-2xl cursor-pointer border-2 ${userAnswers[currentStep] === opt ? 'selected' : 'border-slate-100'}`;
          div.innerHTML = `<span class="font-bold mr-2 uppercase">${opt})</span> ${question[`option_${opt}`]}`;
          div.onclick = () => selectOption(opt);
          container.appendChild(div);
        }
      });

      // Bot√µes
      btnBack.classList.toggle('invisible', currentStep === 0);
      btnNext.textContent = currentStep === questions.length - 1 ? 'Finalizar' : 'Avan√ßar';
      btnNext.disabled = !userAnswers[currentStep];
    }

    function selectOption(opt) {
      userAnswers[currentStep] = opt;
      renderQuiz();
    }

    window.nextStep = async () => {
      if (currentStep < questions.length - 1) {
        currentStep++;
        renderQuiz();
      } else {
        await finishQuiz();
      }
    };

    window.prevStep = () => {
      if (currentStep > 0) {
        currentStep--;
        renderQuiz();
      }
    };

    async function finishQuiz() {
      document.getElementById('loading').classList.remove('hidden');
      
      const score = questions.reduce((acc, q, idx) => {
        return acc + (userAnswers[idx] === q.correct_option ? 1 : 0);
      }, 0);

      const percent = Math.round((score / questions.length) * 100);

      try {
        const { error } = await _supabase
          .from('user_quiz_results')
          .insert({
            user_id: userId,
            lesson_id: lessonId,
            course_id: courseId,
            score: percent,
            answers: userAnswers
          });

        if (error) throw error;

        // Feedback de sucesso e fechamento/redirecionamento
        alert(`Parab√©ns! Voc√™ concluiu com ${percent}% de acerto.`);
        window.parent.postMessage({ type: 'QUIZ_COMPLETE', lessonId }, '*');
      } catch (err) {
        console.error("Erro ao salvar resultado:", err);
        alert("Erro ao salvar seu resultado. Tente novamente.");
      } finally {
        document.getElementById('loading').classList.add('hidden');
      }
    }

    function showError(msg) {
      document.getElementById('quiz-container').innerHTML = `
        <div class="text-center p-8 bg-red-50 rounded-3xl border border-red-100">
          <div class="text-4xl mb-4">‚ö†Ô∏è</div>
          <h2 class="text-lg font-bold text-red-800 mb-2">Ops! Algo deu errado</h2>
          <p class="text-red-600">${msg}</p>
        </div>
      `;
      document.getElementById('quiz-container').classList.remove('hidden');
    }

    document.getElementById('btn-next').onclick = window.nextStep;
    document.getElementById('btn-back').onclick = window.prevStep;

    init();
  </script>
</body>
</html>
