<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quiz de Aula</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Carlito&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Carlito', 'sans-serif']
          },
          colors: {
            primary: {
              DEFAULT: '#0ea5e9'
            },
            base: '#f9fafb'
          }
        }
      }
    };
  </script>
</head>
<body class="bg-base text-slate-800 font-sans p-4">

  <div class="max-w-2xl mx-auto">
    <div class="bg-white shadow-md rounded-xl p-6 border border-slate-200">
      <h1 class="text-xl font-bold text-primary text-center mb-6">Avaliação da Aula</h1>
      <div id="quizContent" class="space-y-6">
        <p class="text-sm text-slate-500">Carregando quiz...</p>
      </div>
    </div>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://bkueljjvhijojzcyodvk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrdWVsamp2aGlqb2p6Y3lvZHZrIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0MzUwNTQ4OSwiZXhwIjoyMDU5MDgxNDg5fQ.o-G5KmxoyfQjeNM5e7rbgxpryOHYC9k1OIo9fYzyeYE'
    );

    const params = new URLSearchParams(window.location.search);
    const userId = params.get('user_id');
    const lessonId = params.get('lesson_id');

    if (!userId || !lessonId) {
      document.getElementById('quizContent').innerHTML =
        '<p class="text-red-600 font-semibold">Parâmetros "user_id" e "lesson_id" são obrigatórios na URL.</p>';
      throw new Error('Parâmetros ausentes na URL.');
    }

    async function loadQuiz() {
      const { data, error } = await supabase
        .from('quiz_view')
        .select('*')
        .eq('id_aula', lessonId);

      if (error || !data || data.length === 0) {
        document.getElementById('quizContent').innerHTML =
          `<p class="text-red-600">Erro ao carregar perguntas.</p>`;
        return;
      }

      const grouped = {};
      data.forEach(row => {
        const pid = row.id_pergunta;
        if (!grouped[pid]) {
          grouped[pid] = {
            id_pergunta: pid,
            pergunta: row.pergunta,
            quiz_id: row.id_quiz,
            alternatives: []
          };
        }
        grouped[pid].alternatives.push({
          alternativa: row.alternativa,
          is_correct: row.is_correct
        });
      });

      const questions = Object.values(grouped);
      renderQuiz(questions);
    }

    function renderQuiz(questions) {
      const container = document.getElementById('quizContent');
      container.innerHTML = '';

      const form = document.createElement('form');
      form.id = 'quizForm';
      form.className = 'space-y-6';

      questions.forEach((question, index) => {
        const qBlock = document.createElement('div');
        qBlock.className = 'p-4 bg-slate-50 border border-slate-200 rounded-md';

        const title = document.createElement('p');
        title.className = 'font-semibold mb-2 text-slate-700';
        title.textContent = `${index + 1}. ${question.pergunta}`;
        qBlock.appendChild(title);

        question.alternatives.forEach((alt, i) => {
          const label = document.createElement('label');
          label.className = 'flex items-center space-x-2 mb-1 text-sm';

          const input = document.createElement('input');
          input.type = 'radio';
          input.name = question.id_pergunta;
          input.value = i;
          input.required = true;

          label.appendChild(input);
          label.appendChild(document.createTextNode(alt.alternativa));
          qBlock.appendChild(label);
        });

        form.appendChild(qBlock);
      });

      const submit = document.createElement('button');
      submit.type = 'submit';
      submit.textContent = 'Enviar Respostas';
      submit.className = 'bg-primary text-white px-4 py-2 rounded shadow hover:brightness-110 transition';
      form.appendChild(submit);

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        await submitQuiz(questions);
      });

      container.appendChild(form);
    }

    async function submitQuiz(questions) {
      const formData = new FormData(document.getElementById('quizForm'));
      let score = 0;
      const total = questions.length;
      const answersArray = [];

      questions.forEach(q => {
        const selected = formData.get(q.id_pergunta);
        const answer = q.alternatives[selected];
        answersArray.push({ question_id: q.id_pergunta, selected_index: selected });
        if (answer && answer.is_correct) score++;
      });

      const payload = {
        user_id: userId,
        quiz_id: questions[0].quiz_id,
        answers: answersArray,
        score,
        total
      };

      const { error } = await supabase
        .from('user_quiz_results')
        .insert(payload);

      if (error) {
        document.getElementById('quizContent').innerHTML =
          `<p class="text-red-600">Erro ao enviar respostas.</p>`;
        return;
      }

      exibirResultado(score, total);


<!-- INSIRA abaixo de `exibirResultado(score, total)` -->
function exibirResultado(score, total) {
  const container = document.getElementById('quizContent');
  container.innerHTML = `
    <div class="text-center bg-emerald-50 border border-emerald-300 p-6 rounded-lg mb-6">
      <h2 class="text-lg font-bold text-emerald-800 mb-2">Resultado</h2>
      <p class="text-slate-700">Você acertou <strong>${score}</strong> de <strong>${total}</strong> perguntas.</p>
    </div>

    <div class="bg-white border border-slate-200 p-6 rounded-lg">
      <h3 class="text-lg font-semibold mb-4 text-slate-800">Agora queremos ouvir sua opinião sobre esta aula:</h3>
      <form id="feedbackForm" class="space-y-4">

        <div>
          <label class="block text-sm font-medium mb-1">1. Como você se sentiu em relação ao seu aprendizado durante esta aula?</label>
          <select name="aprendizado" class="w-full border rounded p-2" required>
            <option value="">Selecione uma opção</option>
            <option value="Aprendi com facilidade e me senti engajado">Aprendi com facilidade e me senti engajado</option>
            <option value="Aprendi com algum esforço, mas consegui acompanhar">Aprendi com algum esforço, mas consegui acompanhar</option>
            <option value="Tive dificuldades para aprender o conteúdo">Tive dificuldades para aprender o conteúdo</option>
            <option value="Não consegui me conectar com o aprendizado">Não consegui me conectar com o aprendizado</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">2. O conteúdo desta aula fez sentido para você e contribuiu para sua aprendizagem?</label>
          <select name="conteudo" class="w-full border rounded p-2" required>
            <option value="">Selecione uma opção</option>
            <option value="Contribuiu muito e fez total sentido">Contribuiu muito e fez total sentido</option>
            <option value="Contribuiu parcialmente">Contribuiu parcialmente</option>
            <option value="Trouxe poucas contribuições para mim">Trouxe poucas contribuições para mim</option>
            <option value="Não fez sentido para meu momento de aprendizagem">Não fez sentido para meu momento de aprendizagem</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">3. Este tema dialoga com suas necessidades, interesses ou desafios atuais?</label>
          <select name="pertinencia" class="w-full border rounded p-2" required>
            <option value="">Selecione uma opção</option>
            <option value="Sim, totalmente">Sim, totalmente</option>
            <option value="Em parte">Em parte</option>
            <option value="Pouco">Pouco</option>
            <option value="Não dialoga">Não dialoga</option>
          </select>
        </div>

        <button type="submit" class="bg-primary text-white px-4 py-2 rounded shadow hover:brightness-110 transition">
          Enviar Avaliação
        </button>
      </form>
    </div>
  `;

  // Submete o feedback qualitativo para a mesma tabela
  document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);

    const payload = {
      user_id: userId,
      lesson_id: lessonId,
      quiz_id: questions[0].quiz_id,
      score: null, // ⚠️ Importante para diferenciar do quiz objetivo
      total: null,
      answers: null,
      qualidade: formData.get('aprendizado'),
      sentido: formData.get('conteudo'),
      dificuldade: formData.get('pertinencia')
    };

    const { error } = await supabase.from('user_quiz_results').insert(payload);

    if (error) {
      alert("Erro ao enviar feedback qualitativo.");
      console.error(error);
      return;
    }

    e.target.innerHTML = `<p class="text-green-700 font-semibold mt-4">✅ Obrigado por compartilhar sua opinião!</p>`;
  });
}

      
    }

    function exibirResultado(score, total) {
      const container = document.getElementById('quizContent');
      container.innerHTML = `
        <div class="text-center bg-emerald-50 border border-emerald-300 p-6 rounded-lg">
          <h2 class="text-lg font-bold text-emerald-800 mb-2">Resultado</h2>
          <p class="text-slate-700">Você acertou <strong>${score}</strong> de <strong>${total}</strong> perguntas.</p>
        </div>
      `;
    }

    loadQuiz();
  </script>
</body>
</html>
