<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Avalia√ß√£o da Aula</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
  <style> 
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Outfit:wght@300;400;600&display=swap');
    body { font-family: 'Outfit', sans-serif; }
    .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    .option-card { transition: all 0.2s ease; border: 2px solid #f1f5f9; }
    .option-card:hover { border-color: #3B82F6; background: #EFF6FF; }
    .option-card.selected { border-color: #2563EB; background: #DBEAFE; font-weight: 600; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">

  <div id="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-white">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
  </div>

  <div class="max-w-2xl mx-auto px-4 py-8">
    <div id="quiz-container" class="hidden">
      <div class="mb-8 text-center">
        <h1 id="lesson-title" class="text-2xl font-bold text-slate-800 font-['Nunito'] mb-2">Avalia√ß√£o da Aula</h1>
        <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
          <div id="progress-bar" class="bg-blue-600 h-full w-0 transition-all duration-500"></div>
        </div>
        <p id="step-indicator" class="text-sm text-slate-500 mt-2 font-medium">Pergunta 1 de ...</p>
      </div>

      <div class="glass-card rounded-3xl p-8 shadow-xl border border-white mb-6">
        <div id="question-content">
          <h2 id="question-text" class="text-xl text-slate-800 font-semibold mb-6">A carregar pergunta...</h2>
          <div id="options-container" class="space-y-3">
            </div>
        </div>
      </div>

      <div class="flex justify-between items-center">
        <button id="btn-back" class="px-6 py-3 text-slate-600 font-semibold hover:bg-slate-100 rounded-xl transition invisible">Voltar</button>
        <button id="btn-next" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-200 hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>Avan√ßar</button>
      </div>
    </div>
  </div>

  <script type="module">
    // --- CONFIGURA√á√ÉO SUPABASE ---
    const SUPABASE_URL = 'https://hiigckoowkrpewlybfef.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhpaWdja29vd2tycGV3bHliZmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTc3NzIsImV4cCI6MjA4MzI5Mzc3Mn0.b5Uf3GXkE_jOVE0J1h3ssWdldiFjm6qQ1yUZr_Mu3Oo';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let questions = [];
    let currentStep = 0;
    let userAnswers = {};
    
    // Captura Par√¢metros da URL
    const params = new URLSearchParams(window.location.search);
    const userId = params.get('user_id');
    const lessonId = params.get('lesson_id');
    const courseId = params.get('course_id');

    async function initQuiz() {
      console.log("üîç Par√¢metros recebidos:", { userId, lessonId, courseId });

      if (!lessonId || lessonId === "false") {
        showError("ID da aula inv√°lido. N√£o √© poss√≠vel carregar as perguntas.");
        return;
      }

      try {
        const { data, error } = await _supabase
          .from('questions')
          .select('*')
          .eq('lesson_id', lessonId)
          .order('order', { ascending: true });

        if (error) throw error;

        if (!data || data.length === 0) {
          showError("Nenhuma pergunta encontrada para esta aula.");
          return;
        }

        questions = data;
        renderStep();
      } catch (err) {
        console.error("‚ùå Erro ao carregar quiz:", err);
        showError("Erro na liga√ß√£o ao banco de dados: " + err.message);
      } finally {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('quiz-container').classList.remove('hidden');
      }
    }

    function renderStep() {
      const question = questions[currentStep];
      const optionsContainer = document.getElementById('options-container');
      const questionText = document.getElementById('question-text');
      const stepIndicator = document.getElementById('step-indicator');
      const progressBar = document.getElementById('progress-bar');
      const btnNext = document.getElementById('btn-next');
      const btnBack = document.getElementById('btn-back');

      // Atualiza Texto e Progresso
      questionText.textContent = question.question_text;
      stepIndicator.textContent = `Pergunta ${currentStep + 1} de ${questions.length}`;
      progressBar.style.width = `${((currentStep + 1) / questions.length) * 100}%`;
      
      optionsContainer.innerHTML = '';
      
      // Mapeia op√ß√µes (a, b, c, d, e)
      ['a', 'b', 'c', 'd', 'e'].forEach(optKey => {
        const text = question[`option_${optKey}`];
        if (text) {
          const card = document.createElement('div');
          card.className = `option-card p-4 rounded-2xl cursor-pointer border-2 ${userAnswers[currentStep] === optKey ? 'selected' : ''}`;
          card.innerHTML = `<span class="uppercase font-bold mr-2 text-blue-600">${optKey})</span> ${text}`;
          card.onclick = () => selectOption(optKey);
          optionsContainer.appendChild(card);
        }
      });

      // Controlos de Navega√ß√£o
      btnBack.classList.toggle('invisible', currentStep === 0);
      btnNext.textContent = currentStep === questions.length - 1 ? 'Finalizar' : 'Avan√ßar';
      btnNext.disabled = !userAnswers[currentStep];
    }

    function selectOption(optKey) {
      userAnswers[currentStep] = optKey;
      renderStep();
    }

    async function handleNext() {
      if (currentStep < questions.length - 1) {
        currentStep++;
        renderStep();
      } else {
        await submitQuiz();
      }
    }

    function handleBack() {
      if (currentStep > 0) {
        currentStep--;
        renderStep();
      }
    }

    async function submitQuiz() {
      document.getElementById('loading').classList.remove('hidden');
      
      // C√°lculo de Acertos
      const correctCount = questions.reduce((acc, q, idx) => {
        return acc + (userAnswers[idx] === q.correct_option ? 1 : 0);
      }, 0);

      const scorePercent = Math.round((correctCount / questions.length) * 100);

      try {
        const { error } = await _supabase
          .from('user_quiz_results')
          .insert({
            user_id: userId,
            lesson_id: lessonId,
            course_id: courseId,
            score: scorePercent,
            answers: userAnswers
          });

        if (error) throw error;

        alert(`Avalia√ß√£o conclu√≠da! Acertou ${scorePercent}% das quest√µes.`);
        
        // Avisa a p√°gina pai que o quiz terminou
        window.parent.postMessage({ type: 'QUIZ_COMPLETE', lessonId, score: scorePercent }, '*');
        
      } catch (err) {
        console.error("‚ùå Erro ao guardar resultado:", err);
        alert("Erro ao guardar o resultado. Por favor, tente novamente.");
      } finally {
        document.getElementById('loading').classList.add('hidden');
      }
    }

    function showError(msg) {
      const container = document.getElementById('quiz-container');
      container.innerHTML = `
        <div class="bg-red-50 border border-red-200 text-red-700 px-6 py-8 rounded-3xl text-center">
          <p class="text-4xl mb-4">‚ö†Ô∏è</p>
          <p class="font-bold text-lg mb-2">N√£o foi poss√≠vel carregar a avalia√ß√£o</p>
          <p class="text-sm opacity-80">${msg}</p>
        </div>
      `;
      container.classList.remove('hidden');
      document.getElementById('loading').classList.add('hidden');
    }

    document.getElementById('btn-next').onclick = handleNext;
    document.getElementById('btn-back').onclick = handleBack;

    initQuiz();
  </script>
</body>
</html>
