<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quiz de Aula + Avaliação</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Carlito&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Carlito', 'sans-serif'] },
          colors: {
            primary: { DEFAULT: '#0ea5e9' },
            base: '#f9fafb'
          }
        }
      }
    };
  </script>
</head>
<body class="bg-base text-slate-800 font-sans p-4">
  <div class="max-w-2xl mx-auto">
    <div class="bg-white shadow-md rounded-xl p-6 border border-slate-200">
      <h1 class="text-xl font-bold text-primary text-center mb-6">Avaliação da Aula</h1>
      <div id="quizContent" class="space-y-6">
        <p class="text-sm text-slate-500">Carregando quiz...</p>
      </div>
    </div>
  </div>
  <script>
    const supabase = window.supabase.createClient(
      'https://bkueljjvhijojzcyodvk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrdWVsamp2aGlqb2p6Y3lvZHZrIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0MzUwNTQ4OSwiZXhwIjoyMDU5MDgxNDg5fQ.o-G5KmxoyfQjeNM5e7rbgxpryOHYC9k1OIo9fYzyeYE'
    );


    const params = new URLSearchParams(window.location.search);
    const userId = params.get('user_id');
    const lessonId = params.get('lesson_id');

    if (!userId || !lessonId) {
      document.getElementById('quizContent').innerHTML =
        '<p class="text-red-600 font-semibold">Parâmetros "user_id" e "lesson_id" são obrigatórios na URL.</p>';
      throw new Error('Parâmetros ausentes na URL.');
    }

    async function loadQuiz() {
      const { data, error } = await supabase
        .from('quiz_view')
        .select('*')
        .eq('id_aula', lessonId);

      if (error || !data || data.length === 0) {
        document.getElementById('quizContent').innerHTML =
          `<p class="text-red-600">Erro ao carregar perguntas.</p>`;
        return;
      }

      const grouped = {};
      data.forEach(row => {
        const pid = row.id_pergunta;
        if (!grouped[pid]) {
          grouped[pid] = {
            id_pergunta: pid,
            pergunta: row.pergunta,
            quiz_id: row.id_quiz,
            alternatives: []
          };
        }
        grouped[pid].alternatives.push({ alternativa: row.alternativa, is_correct: row.is_correct });
      });

      const questions = Object.values(grouped);
      renderQuiz(questions);
    }

    function renderQuiz(questions) {
      const container = document.getElementById('quizContent');
      container.innerHTML = '';

      const form = document.createElement('form');
      form.id = 'quizForm';
      form.className = 'space-y-6';

      questions.forEach((question, index) => {
        const qBlock = document.createElement('div');
        qBlock.className = 'p-4 bg-slate-50 border border-slate-200 rounded-md';

        const title = document.createElement('p');
        title.className = 'font-semibold mb-2 text-slate-700';
        title.textContent = `${index + 1}. ${question.pergunta}`;
        qBlock.appendChild(title);

        question.alternatives.forEach((alt, i) => {
          const label = document.createElement('label');
          label.className = 'flex items-center space-x-2 mb-1 text-sm';

          const input = document.createElement('input');
          input.type = 'radio';
          input.name = question.id_pergunta;
          input.value = i;
          input.required = true;

          label.appendChild(input);
          label.appendChild(document.createTextNode(alt.alternativa));
          qBlock.appendChild(label);
        });

        form.appendChild(qBlock);
      });

      // Avaliação qualitativa
      const qualSection = document.createElement('div');
      qualSection.className = 'space-y-4 border-t pt-6 mt-6';
      qualSection.innerHTML = `
        <p class="font-semibold text-slate-700">4. Como você se sentiu em relação ao seu aprendizado durante esta aula?</p>
        <select required name="aprendizado" class="w-full p-2 border rounded">
          <option value="">Selecione uma opção</option>
          <option>Aprendi com facilidade e me senti engajado</option>
          <option>Aprendi com algum esforço, mas consegui acompanhar</option>
          <option>Tive dificuldades para aprender o conteúdo</option>
          <option>Não consegui me conectar com o aprendizado</option>
        </select>

        <p class="font-semibold text-slate-700">5. O conteúdo desta aula fez sentido para você e contribuiu para sua aprendizagem?</p>
        <select required name="sentido" class="w-full p-2 border rounded">
          <option value="">Selecione uma opção</option>
          <option>Contribuiu muito e fez total sentido</option>
          <option>Contribuiu parcialmente</option>
          <option>Trouxe poucas contribuições para mim</option>
          <option>Não fez sentido para meu momento de aprendizagem</option>
        </select>

        <p class="font-semibold text-slate-700">6. Este tema dialoga com suas necessidades, interesses ou desafios atuais?</p>
        <select required name="relevancia" class="w-full p-2 border rounded">
          <option value="">Selecione uma opção</option>
          <option>Sim, totalmente</option>
          <option>Em parte</option>
          <option>Pouco</option>
          <option>Não dialoga</option>
        </select>
      `;

      form.appendChild(qualSection);

      const submit = document.createElement('button');
      submit.type = 'submit';
      submit.textContent = 'Enviar Avaliação Completa';
      submit.className = 'bg-primary text-white px-4 py-2 rounded shadow hover:brightness-110 transition';
      form.appendChild(submit);

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        await submitQuiz(questions);
      });

      container.appendChild(form);
    }

    async function submitQuiz(questions) {
      const formData = new FormData(document.getElementById('quizForm'));
      let score = 0;
      const total = questions.length;
      const answersArray = [];

      questions.forEach(q => {
        const selected = formData.get(q.id_pergunta);
        const answer = q.alternatives[selected];
        answersArray.push({ question_id: q.id_pergunta, selected_index: selected });
        if (answer && answer.is_correct) score++;
      });

      const payload = {
        user_id: userId,
        lesson_id: lessonId,
        quiz_id: questions[0].quiz_id,
        answers: answersArray,
        score,
        total,
        aprendizado: formData.get('aprendizado'),
        sentido: formData.get('sentido'),
        relevancia: formData.get('relevancia')
      };

      const { error } = await supabase.from('user_quiz_results').insert(payload);

      if (error) {
        document.getElementById('quizContent').innerHTML = `<p class="text-red-600">Erro ao enviar respostas.</p>`;
        return;
      }

      document.getElementById('quizContent').innerHTML = `
        <div class="text-center bg-emerald-50 border border-emerald-300 p-6 rounded-lg">
          <h2 class="text-lg font-bold text-emerald-800 mb-2">Obrigado!</h2>
          <p class="text-slate-700">Sua avaliação foi registrada com sucesso.</p>
        </div>
      `;
    }

    loadQuiz();
  </script>
</body>
</html>
