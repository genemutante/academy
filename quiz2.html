<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Avaliação de Aprendizado</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0f7ff',
              100: '#e0f0ff',
              200: '#c0e0ff',
              300: '#90c8ff',
              400: '#60a8ff',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8',
              800: '#1e40af',
              900: '#1e3a8a'
            }
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif']
          },
          boxShadow: {
            'custom': '0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)'
          }
        }
      }
    };
  </script>
</head>
<body class="bg-gradient-to-br from-slate-100 to-slate-200 text-slate-800 font-sans min-h-screen flex items-center justify-center p-4">
  <div class="max-w-xl w-full mx-auto bg-white rounded-2xl shadow-custom p-8 border border-slate-100" id="quizContainer">
    <div class="flex items-center justify-center mb-6">
      <div class="bg-primary-600 text-white w-12 h-12 rounded-full flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" />
        </svg>
      </div>
    </div>
    <h1 class="text-2xl font-bold text-center text-slate-800 mb-2">Avaliação da Aula</h1>
    <p class="text-slate-500 text-center mb-8">Compartilhe sua experiência e ajude a melhorar nosso conteúdo</p>
    
    <div class="flex items-center justify-between mb-2">
      <span class="text-xs font-medium text-slate-600" id="progressText">Questão 1 de 6</span>
      <span class="text-xs font-medium text-primary-600" id="timeRemaining"></span>
    </div>
    
    <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden mb-8">
      <div class="h-full bg-gradient-to-r from-primary-500 to-primary-600 transition-all duration-500" id="progressFill" style="width: 0%"></div>
    </div>
    
    <div id="stepContent" class="min-h-[280px]"></div>
    
    <div class="flex justify-between mt-8 pt-4 border-t border-slate-100">
      <button id="btnBack" class="bg-white border border-slate-300 text-slate-700 px-5 py-2.5 rounded-lg font-medium hover:bg-slate-50 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
        </svg>
        Voltar
      </button>
      <button id="btnNext" class="bg-primary-600 text-white px-5 py-2.5 rounded-lg font-medium hover:bg-primary-700 transition shadow-sm flex items-center gap-2">
        Avançar
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
        </svg>
      </button>
    </div>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://bkueljjvhijojzcyodvk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrdWVsamp2aGlqb2p6Y3lvZHZrIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0MzUwNTQ4OSwiZXhwIjoyMDU5MDgxNDg5fQ.o-G5KmxoyfQjeNM5e7rbgxpryOHYC9k1OIo9fYzyeYE'
    );

    const params = new URLSearchParams(window.location.search);
    const userId = params.get('user_id');
    const lessonId = params.get('lesson_id');

    if (!userId || !lessonId) {
      document.getElementById('quizContainer').innerHTML = `
        <div class="text-center p-8">
          <div class="bg-red-100 text-red-700 p-4 rounded-lg mb-4 inline-flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            Parâmetros Ausentes
          </div>
          <p class="text-slate-600">Os parâmetros "user_id" e "lesson_id" são necessários na URL.</p>
        </div>`;
      throw new Error('Parâmetros ausentes.');
    }

    let steps = [], currentStep = 0;
    const answers = {};
    let startTime;

    const stepContent = document.getElementById('stepContent');
    const btnBack = document.getElementById('btnBack');
    const btnNext = document.getElementById('btnNext');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const timeRemaining = document.getElementById('timeRemaining');

    // Função para formatar o tempo restante
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Animações
    function fadeIn(element) {
      element.classList.add('opacity-0');
      setTimeout(() => {
        element.classList.remove('opacity-0');
        element.classList.add('transition-opacity', 'duration-500');
      }, 50);
    }

    async function carregarQuiz() {
      stepContent.innerHTML = `
        <div class="flex justify-center items-center h-[280px]">
          <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600 mb-4"></div>
            <p class="text-slate-500">Carregando perguntas...</p>
          </div>
        </div>`;

      const { data, error } = await supabase.from('quiz_view').select('*').eq('id_aula', lessonId);
      if (error || !data || data.length === 0) {
        stepContent.innerHTML = `
          <div class="flex justify-center items-center h-[280px]">
            <div class="text-center p-6 bg-red-50 rounded-xl border border-red-200 max-w-md">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <h2 class="text-lg font-bold text-red-800 mb-2">Erro ao Carregar Perguntas</h2>
              <p class="text-slate-700">Não foi possível carregar o questionário para esta aula. Por favor, tente novamente mais tarde.</p>
            </div>
          </div>`;
        return;
      }

      const grouped = {};
      data.forEach(row => {
        const pid = row.id_pergunta;
        if (!grouped[pid]) {
          grouped[pid] = {
            type: 'quiz',
            id: pid,
            question: row.pergunta,
            quiz_id: row.id_quiz,
            options: []
          };
        }
        grouped[pid].options.push({ text: row.alternativa, is_correct: row.is_correct });
      });

      steps = Object.values(grouped);
      steps.push(
        { 
          type: 'qual', 
          id: 'aprendizado', 
          question: 'Como você se sentiu em relação ao seu aprendizado durante esta aula?', 
          options: [
            'Aprendi com facilidade e me senti engajado', 
            'Aprendi com algum esforço, mas consegui acompanhar', 
            'Tive dificuldades para aprender o conteúdo', 
            'Não consegui me conectar com o aprendizado'
          ] 
        },
        { 
          type: 'qual', 
          id: 'sentido', 
          question: 'O conteúdo desta aula fez sentido para você e contribuiu para sua aprendizagem?', 
          options: [
            'Contribuiu muito e fez total sentido', 
            'Contribuiu parcialmente', 
            'Trouxe poucas contribuições para mim', 
            'Não fez sentido para meu momento de aprendizagem'
          ] 
        },
        { 
          type: 'qual', 
          id: 'relevancia', 
          question: 'Este tema dialoga com suas necessidades, interesses ou desafios atuais?', 
          options: [
            'Sim, totalmente', 
            'Em parte', 
            'Pouco', 
            'Não dialoga'
          ] 
        }
      );

      startTime = Date.now();
      renderStep();
    }

    function renderStep() {
      const step = steps[currentStep];
      stepContent.innerHTML = '';
      fadeIn(stepContent);

      progressText.textContent = `Questão ${currentStep + 1} de ${steps.length}`;

      const questionDiv = document.createElement('div');
      questionDiv.className = 'mb-6';
      
      const questionType = document.createElement('span');
      questionType.className = 'inline-block text-xs font-semibold uppercase tracking-wide text-primary-600 mb-2';
      questionType.textContent = step.type === 'quiz' ? 'Conhecimento' : 'Feedback';
      questionDiv.appendChild(questionType);

      const question = document.createElement('h2');
      question.className = 'text-lg font-semibold mb-6 text-slate-800';
      question.textContent = step.question;
      questionDiv.appendChild(question);

      stepContent.appendChild(questionDiv);

      const optionsContainer = document.createElement('div');
      optionsContainer.className = 'space-y-3';
      
      const radios = [];

      step.options.forEach((opt, idx) => {
        const label = document.createElement('label');
        label.className = 'flex items-center p-4 rounded-lg border border-slate-200 transition-all cursor-pointer hover:bg-slate-50';
        if (answers[step.id] == idx) {
          label.classList.add('bg-primary-50', 'border-primary-300');
        }

        const radioContainer = document.createElement('div');
        radioContainer.className = 'mr-3 flex-shrink-0';
        
        const customRadio = document.createElement('div');
        customRadio.className = 'w-5 h-5 rounded-full border-2 border-slate-300 flex items-center justify-center';
        if (answers[step.id] == idx) {
          customRadio.className = 'w-5 h-5 rounded-full border-2 border-primary-600 flex items-center justify-center';
          const innerDot = document.createElement('div');
          innerDot.className = 'w-2.5 h-2.5 rounded-full bg-primary-600';
          customRadio.appendChild(innerDot);
        }
        radioContainer.appendChild(customRadio);

        const input = document.createElement('input');
        input.type = 'radio';
        input.name = step.id;
        input.value = idx;
        input.className = 'sr-only';
        if (answers[step.id] == idx) {
          input.checked = true;
        }

        input.addEventListener('change', () => {
          document.querySelectorAll(`label[for="${step.id}"]`).forEach(lbl => {
            lbl.classList.remove('bg-primary-50', 'border-primary-300');
            lbl.querySelector('.w-5').className = 'w-5 h-5 rounded-full border-2 border-slate-300 flex items-center justify-center';
            lbl.querySelector('.w-5').innerHTML = '';
          });
          
          if (input.checked) {
            label.classList.add('bg-primary-50', 'border-primary-300');
            customRadio.className = 'w-5 h-5 rounded-full border-2 border-primary-600 flex items-center justify-center';
            const innerDot = document.createElement('div');
            innerDot.className = 'w-2.5 h-2.5 rounded-full bg-primary-600';
            customRadio.appendChild(innerDot);
          }
        });

        radioContainer.appendChild(input);
        label.appendChild(radioContainer);
        
        const textContainer = document.createElement('div');
        textContainer.className = 'flex-grow';
        textContainer.textContent = opt.text || opt;
        label.appendChild(textContainer);
        
        label.setAttribute('for', step.id);
        radios.push(input);
        optionsContainer.appendChild(label);
      });

      stepContent.appendChild(optionsContainer);
      
      btnBack.disabled = currentStep === 0;
      btnNext.innerHTML = currentStep === steps.length - 1 ? 
        'Finalizar <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>' : 
        'Avançar <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>';
      
      progressFill.style.width = `${((currentStep + 1) / steps.length) * 100}%`;
    }

    btnBack.addEventListener('click', () => {
      if (currentStep > 0) {
        btnNext.disabled = false;
        btnNext.innerHTML = 'Avançar <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>';
        currentStep--;
        renderStep();
      }
    });

    btnNext.addEventListener('click', async () => {
      const radios = document.querySelectorAll(`input[name="${steps[currentStep].id}"]`);
      const selected = [...radios].find(r => r.checked);
      
      if (!selected) {
        // Aviso de seleção obrigatória
        const existingAlert = document.getElementById('alertMessage');
        if (!existingAlert) {
          const alert = document.createElement('div');
          alert.id = 'alertMessage';
          alert.className = 'text-sm text-red-600 mt-4 flex items-center justify-center';
          alert.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            Por favor, selecione uma opção para continuar.
          `;
          stepContent.appendChild(alert);
          
          // Animação de shake no botão próximo
          btnNext.classList.add('animate-pulse');
          setTimeout(() => btnNext.classList.remove('animate-pulse'), 1000);
          
          setTimeout(() => {
            if (document.getElementById('alertMessage')) {
              document.getElementById('alertMessage').remove();
            }
          }, 3000);
        }
        return;
      }
      
      answers[steps[currentStep].id] = selected.value;

      if (currentStep < steps.length - 1) {
        currentStep++;
        renderStep();
      } else {
        btnNext.disabled = true;
        btnBack.disabled = true;
        btnNext.innerHTML = `
          <span class="flex items-center">
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Enviando...
          </span>`;

        const quizId = steps[0].quiz_id;
        const quizAnswers = steps.filter(s => s.type === 'quiz').map(s => ({
          question_id: s.id,
          selected_index: answers[s.id]
        }));

        const score = steps.filter(s => s.type === 'quiz').reduce((acc, s) => {
          const correct = s.options[answers[s.id]];
          return acc + (correct && correct.is_correct ? 1 : 0);
        }, 0);

        const elapsedTime = Math.floor((Date.now() - startTime) / 1000);

        const payload = {
          user_id: userId,
          lesson_id: lessonId,
          quiz_id: quizId,
          answers: quizAnswers,
          score,
          total: quizAnswers.length,
          elapsed_time: elapsedTime,
          aprendizado: steps.find(s => s.id === 'aprendizado').options[answers['aprendizado']],
          sentido: steps.find(s => s.id === 'sentido').options[answers['sentido']],
          relevancia: steps.find(s => s.id === 'relevancia').options[answers['relevancia']]
        };

        try {
          const { error } = await supabase.from('user_quiz_results').insert(payload);
          if (error) throw error;
          
          // Animação de sucesso
          document.getElementById('progressFill').style.width = '100%';
          
          // Mostrar resultado
          stepContent.innerHTML = `
            <div class="flex flex-col items-center justify-center py-8">
              <div class="w-16 h-16 rounded-full bg-green-100 flex items-center justify-center mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <h2 class="text-2xl font-bold text-slate-800 mb-2">Avaliação Concluída</h2>
              <p class="text-slate-500 text-center mb-6">Suas respostas foram registradas com sucesso.<br>Obrigado pelo seu feedback!</p>
              
              <div class="bg-slate-50 rounded-lg p-4 w-full">
                <div class="flex justify-between items-center">
                  <span class="text-slate-500">Pontuação</span>
                  <span class="text-lg font-bold text-primary-600">${score}/${quizAnswers.length}</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-2 mt-2">
                  <div class="bg-primary-600 h-2 rounded-full" style="width: ${(score/quizAnswers.length*100)}%"></div>
                </div>
              </div>
            </div>`;
            
          progressText.textContent = 'Concluído';
          btnBack.style.display = 'none';
          btnNext.style.display = 'none';
          
        } catch (error) {
          stepContent.innerHTML = `
            <div class="flex flex-col items-center justify-center py-6">
              <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </div>
              <h2 class="text-xl font-bold text-slate-800 mb-2">Erro ao Enviar Avaliação</h2>
              <p class="text-slate-500 text-center mb-4">Não foi possível salvar suas respostas. Por favor, tente novamente.</p>
              <button class="bg-primary-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-primary-700 transition shadow-sm" onclick="location.reload()">
                Tentar Novamente
              </button>
            </div>`;
        }
      }
    });

    // Adicionar timer para a aparência mais premium
    let timerInterval;
    function startTimer() {
      const maxTime = 600; // 10 minutos
      let timeLeft = maxTime;
      
      timerInterval = setInterval(() => {
        timeLeft--;
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          // Apenas para demonstração - na versão real poderia forçar o envio
          timeRemaining.textContent = "Tempo esgotado";
          timeRemaining.classList.add('text-red-600');
        } else {
          timeRemaining.textContent = `Tempo restante: ${formatTime(timeLeft)}`;
          if (timeLeft < 60) {
            timeRemaining.classList.add('text-red-600');
          }
        }
      }, 1000);
      
      timeRemaining.textContent = `Tempo restante: ${formatTime(timeLeft)}`;
    }

    // Iniciar o quiz
    carregarQuiz();
    startTimer();
  </script>
</body>
</html>
