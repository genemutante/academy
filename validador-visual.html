<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Validador Visual de Progresso</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    .grid-segmentos {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 10px;
      margin-top: 1rem;
    }

    .segmento-item {
      background-color: #f9fafb;
      border-left: 4px solid #2563eb;
      border-radius: 6px;
      padding: 8px 12px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 1px 1px 2px rgba(0,0,0,0.04);
      transition: all 0.2s ease-in-out;
    }

    .segmento-item:hover {
      background-color: #e0f2fe;
      transform: scale(1.01);
    }

    .tempo {
      display: flex;
      gap: 4px;
      align-items: baseline;
      font-weight: 600;
    }

    .h { color: #4f46e5; }
    .m { color: #059669; }
    .s { color: #eab308; }
    .texto { color: #111827; }

    .calculado {
      background-color: #fef9c3;
      border-left-color: #d97706;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans p-6">

  <h1 class="text-2xl font-bold mb-6 flex items-center gap-2">🔍 Validador Visual de Progresso</h1>

  <div class="flex flex-wrap gap-4 items-center mb-6">
    <div>
      <label class="block font-semibold mb-1">👤 Aluno</label>
      <select id="aluno" class="px-3 py-2 border rounded w-64"></select>
    </div>
    <div>
      <label class="block font-semibold mb-1">🎓 Curso</label>
      <select id="curso" class="px-3 py-2 border rounded w-64"></select>
    </div>
    <div>
      <label class="block font-semibold mb-1">📚 Aula</label>
      <select id="aula" class="px-3 py-2 border rounded w-64"></select>
    </div>
    <button id="btnCalcular" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded h-fit mt-6">
      🔎 Calcular Progresso
    </button>
  </div>

  <section id="resultado" class="bg-white p-6 rounded shadow hidden">
    <h2 class="text-lg font-semibold mb-4">📊 Resultado</h2>

    <div>
      <h3 class="font-semibold text-gray-600 mb-2">⏱️ Segmentos assistidos:</h3>
      <div id="listaSegmentos" class="grid-segmentos"></div>
    </div>
  </section>

  <script>
    const supabase = supabase.createClient(
      'https://bkueljjvhijojzcyodvk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrdWVsamp2aGlqb2p6Y3lvZHZrIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTY5MzM3MzAwMCwiZXhwIjoxOTQ3OTQ5ODAwfQ.3Syb8UllrGmM-cO_8iOQ9cQlzy1WbDgOnfeqjDliACQ'
    );

    const alunoSelect = document.getElementById('aluno');
    const cursoSelect = document.getElementById('curso');
    const aulaSelect = document.getElementById('aula');
    const resultado = document.getElementById('resultado');

    async function carregarDadosIniciais() {
      const { data: users } = await supabase.from('users').select('id, name');
      alunoSelect.innerHTML = users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');

      const { data: cursos } = await supabase.from('courses').select('id, title');
      cursoSelect.innerHTML = cursos.map(c => `<option value="${c.id}">${c.title}</option>`).join('');

      cursoSelect.addEventListener('change', carregarAulas);
      carregarAulas();
    }

    async function carregarAulas() {
      const course_id = cursoSelect.value;
      const { data: aulas } = await supabase.from('lessons').select('id, title').eq('course_id', course_id);
      aulaSelect.innerHTML = aulas.map(a => `<option value="${a.id}">${a.title}</option>`).join('');
    }

    function formatarParte(valor, tipo) {
      const cores = { h: 'h', m: 'm', s: 's' };
      return `<span class="${cores[tipo]}">${String(valor).padStart(2, '0')}${tipo}</span>`;
    }

    function formatarSegmento(start, end) {
      const hs = Math.floor(start / 3600), ms = Math.floor((start % 3600) / 60), ss = start % 60;
      const he = Math.floor(end / 3600), me = Math.floor((end % 3600) / 60), se = end % 60;

      return `
        <div class="segmento-item">
          <span class="tempo">
            ${formatarParte(hs, 'h')} ${formatarParte(ms, 'm')} ${formatarParte(ss, 's')}
          </span>
          <span class="texto">→</span>
          <span class="tempo">
            ${formatarParte(he, 'h')} ${formatarParte(me, 'm')} ${formatarParte(se, 's')}
          </span>
        </div>`;
    }

    document.getElementById('btnCalcular').addEventListener('click', async () => {
      const user_id = alunoSelect.value;
      const lesson_id = aulaSelect.value;

      const { data: segmentos } = await supabase
        .from('progress_segments')
        .select('segment')
        .eq('user_id', user_id)
        .eq('lesson_id', lesson_id);

      const brutos = segmentos.map(s => s.segment);
      document.getElementById('listaSegmentos').innerHTML = brutos.map(s => formatarSegmento(s.start, s.end)).join('');
      resultado.classList.remove('hidden');
    });

    carregarDadosIniciais();
  </script>
</body>
</html>
