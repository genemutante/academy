<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ” Validador Visual de Progresso</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    .grade-progresso {
      display: grid;
      grid-template-columns: repeat(60, 1fr);
      gap: 2px;
      margin: 16px 0;
    }
    .bloco {
      height: 12px;
      border-radius: 2px;
    }
    .vazio { background-color: #e5e7eb; }
    .valido { background-color: #10b981; }    /* verde: assistido */
    .duplicado { background-color: #3b82f6; } /* azul: repetido */
    .invalido { background-color: #ef4444; }  /* vermelho: invÃ¡lido */
  </style>
</head>
<body class="bg-gray-50 text-gray-800 p-6 font-sans">

  <h1 class="text-2xl font-bold text-blue-700 mb-6">ğŸ” Validador Visual de Progresso</h1>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div>
      <label class="block font-medium mb-1">ğŸ‘¤ Aluno</label>
      <select id="aluno" class="w-full border p-2 rounded"></select>
    </div>
    <div>
      <label class="block font-medium mb-1">ğŸ“ Curso</label>
      <select id="curso" class="w-full border p-2 rounded"></select>
    </div>
    <div>
      <label class="block font-medium mb-1">ğŸ“š Aula</label>
      <select id="aula" class="w-full border p-2 rounded"></select>
    </div>
  </div>

  <button id="btnCalcular" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">ğŸ” Calcular Progresso</button>

  <div id="resultado" class="mt-10 hidden">
    <h2 class="text-xl font-semibold mb-4">ğŸ“Š Resultado</h2>
    <div id="visualizador" class="grade-progresso"></div>
    <label class="inline-flex items-center mt-2 cursor-pointer">
      <input type="checkbox" id="toggleTracking" class="form-checkbox" checked>
      <span class="ml-2 text-sm">Mostrar segmentos assistidos brutos (tracking)</span>
    </label>
    <div id="brutos" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 mt-4 text-sm font-mono text-gray-700"></div>
  </div>

  <script>
    const supabase = supabase.createClient(
      'https://bkueljjvhijojzcyodvk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrdWVsamp2aGlqb2p6Y3lvZHZrIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0MzUwNTQ4OSwiZXhwIjoyMDU5MDgxNDg5fQ.o-G5KmxoyfQjeNM5e7rbgxpryOHYC9k1OIo9fYzyeYE'
    );

    const alunoSelect = document.getElementById("aluno");
    const cursoSelect = document.getElementById("curso");
    const aulaSelect = document.getElementById("aula");
    const resultado = document.getElementById("resultado");
    const visualizador = document.getElementById("visualizador");
    const brutos = document.getElementById("brutos");

    document.getElementById("btnCalcular").addEventListener("click", calcularProgresso);
    document.getElementById("toggleTracking").addEventListener("change", e => {
      brutos.style.display = e.target.checked ? "grid" : "none";
    });

    async function carregarDadosIniciais() {
      const { data: users } = await supabase.from("users").select("id, name");
      const { data: cursos } = await supabase.from("courses").select("id, title");

      alunoSelect.innerHTML = users.map(u => `<option value="${u.id}">${u.name}</option>`).join("");
      cursoSelect.innerHTML = cursos.map(c => `<option value="${c.id}">${c.title}</option>`).join("");

      cursoSelect.addEventListener("change", carregarAulas);
      alunoSelect.addEventListener("change", carregarAulas);
      carregarAulas();
    }

    async function carregarAulas() {
      const { data: aulas } = await supabase
        .from("lessons")
        .select("id, title")
        .eq("course_id", cursoSelect.value);
      aulaSelect.innerHTML = aulas.map(a => `<option value="${a.id}">${a.title}</option>`).join("");
    }

    function formatar(seg) {
      const s = v => String(v).padStart(2, "0");
      const h = Math.floor(seg / 3600);
      const m = Math.floor((seg % 3600) / 60);
      const s_ = Math.floor(seg % 60);
      return `${s(h)}h${s(m)}m${s(s_)}s`;
    }

    async function calcularProgresso() {
      resultado.classList.remove("hidden");
      visualizador.innerHTML = "";
      brutos.innerHTML = "";

      const user_id = alunoSelect.value;
      const lesson_id = aulaSelect.value;
      const { data: aula } = await supabase.from("lessons").select("duration").eq("id", lesson_id).single();
      const { data: segmentos } = await supabase
        .from("progress_segments")
        .select("segment")
        .eq("user_id", user_id)
        .eq("lesson_id", lesson_id);

      const duracao = Math.min(3600, aula?.duration || 3600);
      const slots = Array(duracao).fill(0);

      const brutosOrdenados = segmentos
        .map(s => s.segment)
        .filter(s => s.start >= 0 && s.end > s.start && s.end <= duracao)
        .sort((a, b) => a.start - b.start);

      for (let seg of brutosOrdenados) {
        for (let i = seg.start; i < seg.end; i++) {
          slots[i]++;
        }
      }

      // Construir visual
      for (let i = 0; i < duracao; i++) {
        const bloco = document.createElement("div");
        bloco.classList.add("bloco");
        bloco.title = `Segundo ${i}s`;
        if (slots[i] === 0) bloco.classList.add("vazio");
        else if (slots[i] === 1) bloco.classList.add("valido");
        else bloco.classList.add("duplicado");
        visualizador.appendChild(bloco);
      }

      // Tracking bruto
      for (let seg of brutosOrdenados) {
        const div = document.createElement("div");
        div.className = "bg-gray-100 p-2 rounded border border-gray-200 shadow-sm";
        div.textContent = `${formatar(seg.start)} â†’ ${formatar(seg.end)}`;
        brutos.appendChild(div);
      }
    }

    carregarDadosIniciais();
  </script>
</body>
</html>
