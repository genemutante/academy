
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Validador Visual de Progresso</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.5/dist/umd/supabase.min.js"></script>
  <style>
    .tooltip {
      @apply absolute bg-black text-white text-xs px-2 py-1 rounded hidden group-hover:block z-50;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 p-6 font-sans">

<div class="max-w-6xl mx-auto">
  <h1 class="text-2xl font-bold text-blue-800 mb-6 flex items-center gap-2">🔍 Validador Visual de Progresso</h1>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end mb-4">
    <div>
      <label class="block font-semibold mb-1">👤 Aluno</label>
      <select id="aluno" class="w-full p-2 border rounded"></select>
    </div>
    <div>
      <label class="block font-semibold mb-1">🎓 Curso</label>
      <select id="curso" class="w-full p-2 border rounded"></select>
    </div>
    <div>
      <label class="block font-semibold mb-1">📚 Aula</label>
      <select id="aula" class="w-full p-2 border rounded"></select>
    </div>
    <button id="btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
      🔍 Calcular Progresso
    </button>
  </div>

  <div id="resultado" class="mt-8 hidden">
    <h2 class="text-xl font-bold text-gray-800 mb-3">📊 <strong>Tracking de Segmentos:</strong></h2>

    <!-- Legenda -->
    <div class="flex gap-4 text-sm mb-2">
      <div class="flex items-center gap-1"><div class="w-4 h-4 bg-blue-400 rounded-sm"></div> 1x assistido</div>
      <div class="flex items-center gap-1"><div class="w-4 h-4 bg-green-400 rounded-sm"></div> Repetido</div>
      <div class="w-4 h-4 bg-gray-300 border border-gray-400"></div> Não assistido
      <div class="flex items-center gap-1"><div class="w-4 h-4 bg-gray-800 rounded-sm"></div> Fora da aula</div>
    </div>

<div id="painel"
  class="bg-neutral-900 pt-10 pb-4 px-4 rounded shadow overflow-x-auto"
  style="display: grid; grid-template-columns: repeat(120, minmax(4px, 1fr)); gap: 1px;">
</div>


    <!-- Segmentos detalhados -->
 <p class="text-sm text-left mt-2">
  <a href="#" onclick="document.getElementById('detalhes').classList.toggle('hidden')" class="text-blue-700 underline">
    Mostrar/Ocultar Detalhes
  </a>
</p>



    
    <div id="detalhes" class="hidden mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 text-sm font-mono"></div>
  </div>
</div>

<script>
const supabase = window.supabase.createClient(
  'https://bkueljjvhijojzcyodvk.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrdWVsamp2aGlqb2p6Y3lvZHZrIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0MzUwNTQ4OSwiZXhwIjoyMDU5MDgxNDg5fQ.o-G5KmxoyfQjeNM5e7rbgxpryOHYC9k1OIo9fYzyeYE'
);

const MAX_SEGUNDOS = 60 * 60;
const alunoSel = document.getElementById('aluno');
const cursoSel = document.getElementById('curso');
const aulaSel = document.getElementById('aula');
const btn = document.getElementById('btn');
const painel = document.getElementById('painel');
const detalhes = document.getElementById('detalhes');
const resultado = document.getElementById('resultado');

function formatar(seg) {
  const h = String(Math.floor(seg / 3600)).padStart(2, '0');
  const m = String(Math.floor((seg % 3600) / 60)).padStart(2, '0');
  const s = String(seg % 60).padStart(2, '0');
  return `${h}h${m}m${s}s`;
}

async function carregar() {
  const { data: alunos } = await supabase.from('users').select('id, name');
  alunoSel.innerHTML = alunos.map(u => `<option value="${u.id}">${u.name}</option>`).join('');

  const { data: cursos } = await supabase.from('courses').select('id, title');
  cursoSel.innerHTML = cursos.map(c => `<option value="${c.id}">${c.title}</option>`).join('');

  cursoSel.addEventListener('change', carregarAulas);
  carregarAulas();
}

async function carregarAulas() {
  const { data: aulas } = await supabase.from('lessons').select('id, title').eq('course_id', cursoSel.value);
  aulaSel.innerHTML = aulas.map(a => `<option value="${a.id}">${a.title}</option>`).join('');
}

btn.addEventListener('click', async () => {
  painel.innerHTML = '';
  detalhes.innerHTML = '';
  resultado.classList.add('hidden');

  const { data: aula } = await supabase.from('lessons').select('duration').eq('id', aulaSel.value).single();
  const duracao = aula.duration;

  const { data: bruto } = await supabase
    .from('progress_segments')
    .select('segment')
    .eq('user_id', alunoSel.value)
    .eq('lesson_id', aulaSel.value);

  const heatmap = Array(MAX_SEGUNDOS).fill(0);
  bruto.forEach(r => {
    const { start, end } = r.segment;
    if (start >= 0 && end > start && end - start <= 600) {
      for (let s = start; s < end && s < MAX_SEGUNDOS; s++) {
        heatmap[s]++;
      }
    }
  });


const blocos = heatmap.map((qtd, idx) => {
  let bg = 'bg-gray-200 border border-gray-300';
  if (idx >= duracao) {
    bg = 'bg-gray-800';
  } else if (qtd === 0) {
    bg = 'bg-gray-300 border border-gray-400';
  } else if (qtd === 1) {
    bg = 'bg-blue-400';
  } else {
    bg = 'bg-green-400';
  }

  return `<div class="w-2 h-2 ${bg} border border-black/10 rounded-sm relative group">
    <div class="absolute opacity-0 group-hover:opacity-100 transition-opacity duration-200 text-xs text-white bg-black px-2 py-1 rounded shadow-lg -top-6 left-1/2 -translate-x-1/2 whitespace-nowrap z-50 pointer-events-none">
      ${formatar(idx)} • Visto: ${qtd}x
    </div>
  </div>`;
});

    

return `<div 
  class="w-2 h-2 ${bg} border border-black/10 rounded-sm relative group">
  <div class="absolute hidden group-hover:block text-xs text-white bg-black px-1 py-0.5 rounded -top-6 left-1/2 -translate-x-1/2 whitespace-nowrap z-50">
    ${formatar(idx)} • Visto: ${qtd}x
  </div>
</div>`;

  });

  painel.innerHTML = blocos.join('');
  resultado.classList.remove('hidden');

  const linhas = bruto.map(r => `<div class="bg-gray-100 p-2 rounded border">${formatar(r.segment.start)} → ${formatar(r.segment.end)}</div>`);
  detalhes.innerHTML = linhas.join('');
});

carregar();
</script>
</body>
</html>
