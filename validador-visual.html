<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Validador Visual de Progresso</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.5/dist/umd/supabase.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 p-6 font-sans">

  <div class="max-w-6xl mx-auto">
    <h1 class="text-2xl font-bold text-blue-800 mb-6 flex items-center gap-2">ğŸ” Validador Visual de Progresso</h1>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end mb-4">
      <div>
        <label class="block font-semibold mb-1">ğŸ‘¤ Aluno</label>
        <select id="aluno" class="w-full p-2 border rounded"></select>
      </div>
      <div>
        <label class="block font-semibold mb-1">ğŸ“ Curso</label>
        <select id="curso" class="w-full p-2 border rounded"></select>
      </div>
      <div>
        <label class="block font-semibold mb-1">ğŸ“š Aula</label>
        <select id="aula" class="w-full p-2 border rounded"></select>
      </div>
      <button id="btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
        ğŸ” Calcular Progresso
      </button>
    </div>

    <div id="resultado" class="mt-8 hidden">
      <h2 class="text-xl font-bold text-gray-800 mb-3">ğŸ“Š <strong>Tracking de Segmentos:</strong></h2>
      <div id="painel" class="bg-black p-4 rounded shadow overflow-x-auto whitespace-nowrap flex flex-wrap gap-[2px] w-full max-w-full"></div>
      <p class="text-sm text-right mt-1">
        <a href="#" onclick="document.getElementById('detalhes').classList.toggle('hidden')" class="text-blue-700 underline">Mostrar/Ocultar Detalhes</a>
      </p>
      <pre id="detalhes" class="hidden mt-4 p-4 bg-gray-100 rounded overflow-x-auto text-xs text-gray-700 font-mono"></pre>
    </div>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://bkueljjvhijojzcyodvk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrdWVsamp2aGlqb2p6Y3lvZHZrIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0MzUwNTQ4OSwiZXhwIjoyMDU5MDgxNDg5fQ.o-G5KmxoyfQjeNM5e7rbgxpryOHYC9k1OIo9fYzyeYE'
    );

    const alunoSel = document.getElementById('aluno');
    const cursoSel = document.getElementById('curso');
    const aulaSel = document.getElementById('aula');
    const btn = document.getElementById('btn');
    const painel = document.getElementById('painel');
    const resultado = document.getElementById('resultado');
    const detalhes = document.getElementById('detalhes');

    const MAX_SEGUNDOS = 60 * 60;


async function carregar() {
  const { data: alunos, error: erroAlunos } = await supabase.from('users').select('id, name');
  if (erroAlunos || !alunos) {
    alert("Erro ao carregar alunos: " + (erroAlunos?.message || 'Sem dados'));
    return;
  }
  alunoSel.innerHTML = alunos.map(u => `<option value="${u.id}">${u.name}</option>`).join('');

  const { data: cursos, error: erroCursos } = await supabase.from('courses').select('id, title');
  if (erroCursos || !cursos) {
    alert("Erro ao carregar cursos: " + (erroCursos?.message || 'Sem dados'));
    return;
  }
  cursoSel.innerHTML = cursos.map(c => `<option value="${c.id}">${c.title}</option>`).join('');

  cursoSel.addEventListener('change', carregarAulas);
  carregarAulas();
}


    

    async function carregarAulas() {
      const { data: aulas } = await supabase.from('lessons').select('id, title').eq('course_id', cursoSel.value);
      aulaSel.innerHTML = aulas.map(a => `<option value="${a.id}">${a.title}</option>`).join('');
    }

    function formatar(seg) {
      const h = String(Math.floor(seg / 3600)).padStart(2, '0');
      const m = String(Math.floor((seg % 3600) / 60)).padStart(2, '0');
      const s = String(seg % 60).padStart(2, '0');
      return `${h}h${m}m${s}s`;
    }

    btn.addEventListener('click', async () => {
      painel.innerHTML = '';
      detalhes.innerHTML = '';
      resultado.classList.add('hidden');

      const { data: aula } = await supabase.from('lessons').select('duration').eq('id', aulaSel.value).single();
      const duracao = aula.duration;

      const { data: bruto } = await supabase
        .from('progress_segments')
        .select('segment')
        .eq('user_id', alunoSel.value)
        .eq('lesson_id', aulaSel.value);

      // Compactar mÃºltiplos registros e ignorar invÃ¡lidos
      const heatmap = Array(MAX_SEGUNDOS).fill(0);
      bruto.forEach(r => {
        const { start, end } = r.segment;
        if (start >= 0 && end >= 0 && end > start && end - start <= 600) {
          for (let s = start; s < end; s++) {
            if (s < MAX_SEGUNDOS) heatmap[s]++;
          }
        }
      });

      const blocos = heatmap.map((qtd, idx) => {
        let bg = 'bg-gray-200';
        
if (idx >= duracao) {
  bg = 'bg-gray-800'; // fora da aula, visÃ­vel
} else if (qtd === 0) {
  bg = 'bg-gray-600'; // parte da aula nÃ£o assistida
} else if (qtd === 1) {
  bg = 'bg-blue-400'; // assistido uma vez
} else {
  bg = 'bg-green-400'; // assistido mais de uma vez
}
        
        return `<div title="${formatar(idx)} â€¢ Visto: ${qtd}x" class="${bg} w-2 h-2 rounded-sm"></div>`;
      });



      

      painel.innerHTML = blocos.join('');
      resultado.classList.remove('hidden');

      // Exibir detalhes
      const linhas = bruto.map(r => `${formatar(r.segment.start)} â†’ ${formatar(r.segment.end)}`);
      detalhes.textContent = linhas.join('\n');
    });

    carregar();
  </script>
</body>
</html>
