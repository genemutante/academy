<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Validador Visual de Progresso</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    .grid-bruta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 8px;
    }
    .bloco-bruto {
      background: #fff;
      border-left: 4px solid #facc15; /* amarelo */
      padding: 8px 12px;
      font-family: monospace;
      border-radius: 4px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans p-6">

  <h1 class="text-2xl font-bold mb-6 flex items-center gap-2">
    🔍 Validador Visual de Progresso
  </h1>

  <div class="flex flex-wrap gap-4 items-center mb-6">
    <div>
      <label class="block font-semibold mb-1">👤 Aluno</label>
      <select id="aluno" class="px-3 py-2 border rounded w-64"></select>
    </div>
    <div>
      <label class="block font-semibold mb-1">🎓 Curso</label>
      <select id="curso" class="px-3 py-2 border rounded w-64"></select>
    </div>
    <div>
      <label class="block font-semibold mb-1">📊 Aula</label>
      <select id="aula" class="px-3 py-2 border rounded w-64"></select>
    </div>
    <button id="btnCalcular" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded h-fit mt-6">
      🔎 Calcular Progresso
    </button>
  </div>

  <section id="resultado" class="bg-white p-6 rounded shadow hidden">
    <h2 class="text-lg font-semibold mb-4">📊 Resultado</h2>

    <div>
      <h3 class="font-semibold text-gray-600 mb-2">⏱️ Segmentos assistidos:</h3>
      <div id="blocosBrutos" class="grid-bruta mb-4"></div>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full text-sm text-left border border-collapse">
        <thead class="bg-purple-800 text-white">
          <tr>
            <th class="p-2 border text-left">📋 Indicador</th>
            <th class="p-2 border text-center">⏱ Tempo</th>
            <th class="p-2 border text-center">📊 %</th>
            <th class="p-2 border text-center">📌 Status</th>
          </tr>
        </thead>
        <tbody class="bg-black text-white">
          <tr>
            <td class="border p-2 font-semibold">🟥 Duração total da aula</td>
            <td id="duracao" class="border p-2 text-orange-400 text-center"></td>
            <td class="border p-2 text-center">—</td>
            <td class="border p-2 text-center">—</td>
          </tr>
          <tr>
            <td class="border p-2 font-semibold">✅ Algoritmo com lacunas</td>
            <td id="algoritmoTempo" class="border p-2 text-green-400 text-center"></td>
            <td id="algoritmoPercentual" class="border p-2 text-center"></td>
            <td id="algoritmoStatus" class="border p-2 text-center"></td>
          </tr>
          <tr>
            <td class="border p-2 font-semibold">🧮 Função SQL atual</td>
            <td id="sqlTempo" class="border p-2 text-cyan-400 text-center"></td>
            <td id="sqlPercentual" class="border p-2 text-center"></td>
            <td id="sqlStatus" class="border p-2 text-center"></td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td class="border p-2 font-semibold bg-white" colspan="4">
              <p id="diagnostico" class="text-sm font-medium mt-2 text-center text-red-600"></p>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
  </section>

  <script>
    const supabase = window.supabase.createClient(
      'https://bkueljjvhijojzcyodvk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.ey...SUATOKENAQUI...'
    );

    const alunoSelect = document.getElementById('aluno');
    const cursoSelect = document.getElementById('curso');
    const aulaSelect = document.getElementById('aula');
    const btn = document.getElementById('btnCalcular');

    async function carregarDadosIniciais() {
      const { data: users } = await supabase.from('users').select('id, name');
      alunoSelect.innerHTML = users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');

      const { data: cursos } = await supabase.from('courses').select('id, title');
      cursoSelect.innerHTML = cursos.map(c => `<option value="${c.id}">${c.title}</option>`).join('');

      cursoSelect.addEventListener('change', carregarAulas);
      carregarAulas();
    }

    async function carregarAulas() {
      const { data: aulas } = await supabase
        .from('lessons')
        .select('id, title')
        .eq('course_id', cursoSelect.value);

      aulaSelect.innerHTML = aulas.map(a => `<option value="${a.id}">${a.title}</option>`).join('');
    }

    function formatarTempo(segundos) {
      const h = Math.floor(segundos / 3600).toString().padStart(2, '0');
      const m = Math.floor((segundos % 3600) / 60).toString().padStart(2, '0');
      const s = Math.floor(segundos % 60).toString().padStart(2, '0');
      return `${h}h${m}m${s}s`;
    }

    function mergeSegmentos(segmentos) {
      const ordenados = [...segmentos].sort((a, b) => a.start - b.start);
      const unidos = [];
      let atual = ordenados[0];
      for (let i = 1; i < ordenados.length; i++) {
        if (ordenados[i].start <= atual.end) {
          atual.end = Math.max(atual.end, ordenados[i].end);
        } else {
          unidos.push(atual);
          atual = ordenados[i];
        }
      }
      unidos.push(atual);
      return unidos;
    }

    btn.addEventListener('click', async () => {
      const user_id = alunoSelect.value;
      const lesson_id = aulaSelect.value;

      const { data: aula } = await supabase.from('lessons').select('duration').eq('id', lesson_id).single();
      const duracaoTotal = aula.duration;

      const { data: segmentos } = await supabase
        .from('progress_segments')
        .select('segment')
        .eq('user_id', user_id)
        .eq('lesson_id', lesson_id);

      const brutos = segmentos.map(s => s.segment);
      const tratados = mergeSegmentos(brutos);
      const tempoValido = tratados.reduce((soma, seg) => soma + (seg.end - seg.start), 0);
      const percentualValido = +(tempoValido / duracaoTotal * 100).toFixed(1);
      const statusValido = percentualValido >= 97 ? '✅ Concluída' : '❌ Incompleta';

      const { data: sqlData } = await supabase.rpc('fn_progresso_por_usuario_e_aula', {
        p_user_id: user_id,
        p_lesson_id: lesson_id
      });

      const sql = sqlData?.[0] || { segundos_assistidos: 0, percentual_assistido: 0, status: 'desconhecido' };

      document.getElementById('resultado').classList.remove('hidden');
      document.getElementById('duracao').textContent = formatarTempo(duracaoTotal);
      document.getElementById('algoritmoTempo').textContent = formatarTempo(tempoValido);
      document.getElementById('algoritmoPercentual').textContent = `${percentualValido}%`;
      document.getElementById('algoritmoStatus').textContent = statusValido;

      document.getElementById('sqlTempo').textContent = formatarTempo(sql.segundos_assistidos);
      document.getElementById('sqlPercentual').textContent = `${sql.percentual_assistido}%`;
      document.getElementById('sqlStatus').textContent = sql.status === 'concluida' ? '✅ Concluída' : '❓ Desconhecido';

      document.getElementById('diagnostico').textContent = percentualValido >= 97
        ? '✅ O aluno pode ser considerado como tendo concluído a aula.'
        : '❌ A aula ainda não pode ser considerada como concluída.';

      const blocos = document.getElementById('blocosBrutos');
      blocos.innerHTML = '';
      brutos.forEach(s => {
        const el = document.createElement('div');
        el.className = 'bloco-bruto';
        el.textContent = `${formatarTempo(s.start)} → ${formatarTempo(s.end)}`;
        blocos.appendChild(el);
      });
    });

    carregarDadosIniciais();
  </script>
</body>
</html>
