<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>📊 Validador Visual de Progresso</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    .segmento {
      @apply px-3 py-2 bg-yellow-100 border-l-4 border-yellow-500 text-sm rounded shadow;
      font-family: monospace;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans p-6">

  <div class="max-w-5xl mx-auto">
    <h1 class="text-2xl font-bold text-blue-700 mb-6 flex items-center gap-2">
      🔍 Validador Visual de Progresso do Aluno
    </h1>

    <!-- Controles -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div>
        <label class="block font-semibold mb-1">👤 Aluno</label>
        <select id="aluno" class="w-full px-3 py-2 border rounded"></select>
      </div>
      <div>
        <label class="block font-semibold mb-1">🎓 Curso</label>
        <select id="curso" class="w-full px-3 py-2 border rounded"></select>
      </div>
      <div>
        <label class="block font-semibold mb-1">📚 Aula</label>
        <select id="aula" class="w-full px-3 py-2 border rounded"></select>
      </div>
    </div>

    <button id="btnCalcular" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">▶️ Calcular Progresso</button>

    <!-- Resultado -->
    <section id="resultado" class="bg-white p-6 rounded shadow mt-8 hidden">
      <h2 class="text-lg font-semibold mb-4">📊 Resultado da Aula</h2>

      <!-- Tracking -->
      <div class="mb-6">
        <h3 class="font-semibold text-gray-600 mb-2">🟨 Segmentos brutos (tracking real do banco)</h3>
        <div id="segmentosBrutos" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
      </div>

      <!-- Comparação -->
      <div class="grid md:grid-cols-2 gap-6 text-sm">
        <div class="bg-gray-50 p-4 border rounded">
          <h4 class="font-bold text-blue-800 mb-2">🧠 Algoritmo com lacunas</h4>
          <p><strong>Tempo assistido:</strong> <span id="algoritmoTempo"></span></p>
          <p><strong>Percentual:</strong> <span id="algoritmoPercentual"></span>%</p>
          <p><strong>Status:</strong> <span id="algoritmoStatus"></span></p>
        </div>
        <div class="bg-gray-50 p-4 border rounded">
          <h4 class="font-bold text-green-800 mb-2">📦 Função SQL oficial</h4>
          <p><strong>Tempo registrado:</strong> <span id="sqlTempo"></span></p>
          <p><strong>Percentual:</strong> <span id="sqlPercentual"></span>%</p>
          <p><strong>Status:</strong> <span id="sqlStatus"></span></p>
        </div>
      </div>
    </section>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://bkueljjvhijojzcyodvk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrdWVsamp2aGlqb2p6Y3lvZHZrIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0MzUwNTQ4OSwiZXhwIjoyMDU5MDgxNDg5fQ.o-G5KmxoyfQjeNM5e7rbgxpryOHYC9k1OIo9fYzyeYE'
    );

    const alunoSel = document.getElementById('aluno');
    const cursoSel = document.getElementById('curso');
    const aulaSel = document.getElementById('aula');

    async function carregarControles() {
      const { data: users } = await supabase.from('users').select('id, name');
      alunoSel.innerHTML = users.map(u => `<option value="${u.id}">${u.name || u.id}</option>`).join('');

      const { data: cursos } = await supabase.from('courses').select('id, title');
      cursoSel.innerHTML = cursos.map(c => `<option value="${c.id}">${c.title}</option>`).join('');

      cursoSel.addEventListener('change', carregarAulas);
      carregarAulas();
    }

    async function carregarAulas() {
      const { data: aulas } = await supabase
        .from('lessons')
        .select('id, title')
        .eq('course_id', cursoSel.value);
      aulaSel.innerHTML = aulas.map(a => `<option value="${a.id}">${a.title}</option>`).join('');
    }

    function formatarTempo(segundos) {
      const h = String(Math.floor(segundos / 3600)).padStart(2, '0');
      const m = String(Math.floor((segundos % 3600) / 60)).padStart(2, '0');
      const s = String(Math.floor(segundos % 60)).padStart(2, '0');
      return `<strong>${h}</strong>h<strong>${m}</strong>m<strong>${s}</strong>s`;
    }

    function unificarSegmentos(segmentos) {
      const ordenado = [...segmentos].sort((a, b) => a.start - b.start);
      const resultado = [];
      let atual = ordenado[0];
      for (let i = 1; i < ordenado.length; i++) {
        const s = ordenado[i];
        if (s.start <= atual.end) {
          atual.end = Math.max(atual.end, s.end);
        } else {
          resultado.push(atual);
          atual = s;
        }
      }
      resultado.push(atual);
      return resultado;
    }

    document.getElementById('btnCalcular').addEventListener('click', async () => {
      const user_id = alunoSel.value;
      const lesson_id = aulaSel.value;

      const { data: aula } = await supabase.from('lessons').select('duration').eq('id', lesson_id).single();
      const duracao = aula.duration;

      const { data: segmentosData } = await supabase
        .from('progress_segments')
        .select('segment')
        .eq('user_id', user_id)
        .eq('lesson_id', lesson_id);

      const brutos = segmentosData.map(s => s.segment);
      const unificados = unificarSegmentos(brutos);

      const tempoTotal = unificados.reduce((soma, seg) => soma + (seg.end - seg.start), 0);
      const percentual = Math.round((tempoTotal / duracao) * 100);
      const status = percentual >= 97 ? '✔ Concluída' : '🕒 Em andamento';

      const { data: funcao } = await supabase.rpc('fn_progresso_por_usuario_e_aula', {
        p_user_id: user_id,
        p_lesson_id: lesson_id
      });
      const dadosSQL = funcao?.[0];

      // Preencher painel
      document.getElementById('resultado').classList.remove('hidden');
      document.getElementById('segmentosBrutos').innerHTML = brutos.map(s => `
        <div class="segmento">${formatarTempo(s.start)} → ${formatarTempo(s.end)}</div>
      `).join('');

      document.getElementById('algoritmoTempo').innerHTML = formatarTempo(tempoTotal);
      document.getElementById('algoritmoPercentual').textContent = percentual;
      document.getElementById('algoritmoStatus').textContent = status;

      document.getElementById('sqlTempo').innerHTML = formatarTempo(dadosSQL?.segundos_assistidos || 0);
      document.getElementById('sqlPercentual').textContent = Math.round((dadosSQL?.segundos_assistidos / duracao) * 100);
      document.getElementById('sqlStatus').textContent = dadosSQL?.status || 'indefinido';
    });

    carregarControles();
  </script>
</body>
</html>
