<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Validador Visual de Progresso</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    .bloco {
      width: 14px;
      height: 14px;
      display: inline-block;
      margin: 1px;
      border-radius: 2px;
      cursor: pointer;
    }
    .grid-blocos {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(12px, 1fr));
      gap: 1px;
      max-width: 100%;
    }
    .tooltip {
      position: absolute;
      background: #000;
      color: #fff;
      padding: 4px 6px;
      font-size: 10px;
      border-radius: 3px;
      pointer-events: none;
      z-index: 10;
      display: none;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 p-6 font-sans">
  <h1 class="text-2xl font-bold mb-6">🔍 Validador Visual de Progresso</h1>

  <!-- Controles -->
  <div class="flex flex-wrap gap-4 items-end mb-6">
    <div>
      <label class="block font-semibold mb-1">👤 Aluno</label>
      <select id="aluno" class="px-3 py-2 border rounded w-64"></select>
    </div>
    <div>
      <label class="block font-semibold mb-1">🎓 Curso</label>
      <select id="curso" class="px-3 py-2 border rounded w-64"></select>
    </div>
    <div>
      <label class="block font-semibold mb-1">📚 Aula</label>
      <select id="aula" class="px-3 py-2 border rounded w-64"></select>
    </div>
    <button id="btnCalcular" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 h-fit">
      🔎 Calcular Progresso
    </button>
  </div>

  <!-- Resultado -->
  <section id="resultado" class="hidden">
    <h2 class="text-xl font-semibold mb-4">📊 Resultado</h2>
    <button id="toggleTracking" class="mb-4 text-blue-600 underline">👁️ Mostrar Visual de Segmentos</button>
    <div id="trackingGrid" class="grid-blocos mb-6 hidden relative"></div>
    <div class="tooltip" id="tooltip"></div>
    <table class="w-full text-sm border">
      <thead class="bg-purple-900 text-white">
        <tr>
          <th class="text-left p-2">🧠 Indicador</th>
          <th class="text-center p-2">⏱ Tempo</th>
          <th class="text-center p-2">📊 %</th>
          <th class="text-center p-2">📌 Status</th>
        </tr>
      </thead>
      <tbody id="tabelaResultados" class="bg-white text-center"></tbody>
    </table>
  </section>

  <!-- Script -->
  <script>
    const supabase = window.supabase.createClient(
      'https://bkueljjvhijojzcyodvk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ...S3Y'
    );

    const alunoSel = document.getElementById('aluno');
    const cursoSel = document.getElementById('curso');
    const aulaSel = document.getElementById('aula');
    const resultado = document.getElementById('resultado');
    const grid = document.getElementById('trackingGrid');
    const tooltip = document.getElementById('tooltip');

    async function carregarDadosIniciais() {
      const { data: users } = await supabase.from('users').select('id, name');
      alunoSel.innerHTML = users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
      const { data: cursos } = await supabase.from('courses').select('id, title');
      cursoSel.innerHTML = cursos.map(c => `<option value="${c.id}">${c.title}</option>`).join('');
      cursoSel.addEventListener('change', carregarAulas);
      carregarAulas();
    }

    async function carregarAulas() {
      const { data: aulas } = await supabase.from('lessons').select('id, title').eq('course_id', cursoSel.value);
      aulaSel.innerHTML = aulas.map(a => `<option value="${a.id}">${a.title}</option>`).join('');
    }

    function formatar(seg) {
      const h = String(Math.floor(seg / 3600)).padStart(2, '0');
      const m = String(Math.floor((seg % 3600) / 60)).padStart(2, '0');
      const s = String(seg % 60).padStart(2, '0');
      return `${h}h${m}m${s}s`;
    }

    function merge(segmentos) {
      const ordenados = [...segmentos].sort((a, b) => a.start - b.start);
      const result = [];
      let atual = ordenados[0];
      for (let i = 1; i < ordenados.length; i++) {
        const seg = ordenados[i];
        if (seg.start <= atual.end) {
          atual.end = Math.max(atual.end, seg.end);
        } else {
          result.push(atual);
          atual = seg;
        }
      }
      result.push(atual);
      return result;
    }

    function desenharTracking(segmentos, duracao) {
      grid.innerHTML = '';
      const mapa = Array.from({ length: duracao }, () => 0);
      segmentos.forEach(s => {
        if (s.start >= 0 && s.end <= duracao) {
          for (let i = s.start; i < s.end; i++) {
            mapa[i]++;
          }
        }
      });

      mapa.forEach((v, i) => {
        const bloco = document.createElement('div');
        bloco.className = 'bloco';
        bloco.style.background =
          v === 0 ? '#fff' : v === 1 ? '#22c55e' : '#60a5fa'; // branco, verde, azul claro
        bloco.title = `Segundo ${i}: assistido ${v}x`;
        grid.appendChild(bloco);
      });
    }

    function exibirTooltip(evt) {
      tooltip.style.left = evt.pageX + 10 + 'px';
      tooltip.style.top = evt.pageY - 10 + 'px';
      tooltip.style.display = 'block';
      tooltip.innerText = evt.target.title;
    }

    document.getElementById('btnCalcular').addEventListener('click', async () => {
      resultado.classList.remove('hidden');
      grid.classList.add('hidden');
      document.getElementById('toggleTracking').textContent = '👁️ Mostrar Visual de Segmentos';

      const user_id = alunoSel.value;
      const lesson_id = aulaSel.value;

      const { data: aula } = await supabase.from('lessons').select('duration').eq('id', lesson_id).single();
      const duracao = aula.duration;

      const { data: segmentos } = await supabase
        .from('progress_segments')
        .select('segment')
        .eq('user_id', user_id)
        .eq('lesson_id', lesson_id);

      const brutosValidos = segmentos
        .map(s => s.segment)
        .filter(s => s.start >= 0 && s.end > s.start && s.end <= duracao);

      desenharTracking(brutosValidos, duracao);

      const tratados = merge(brutosValidos);
      const tempoTratado = tratados.reduce((acc, s) => acc + (s.end - s.start), 0);
      const percentual = ((tempoTratado / duracao) * 100).toFixed(1);

      const { data: resultadoSQL } = await supabase.rpc('fn_progresso_por_usuario_e_aula', {
        p_user_id: user_id,
        p_lesson_id: lesson_id
      });

      const sql = resultadoSQL?.[0] || { segundos_assistidos: 0, percentual_assistido: 0, status: '?' };

      const linhas = `
        <tr><td class="text-left p-2">📕 Duração total da aula</td>
          <td>${formatar(duracao)}</td><td>${formatar(duracao)}</td><td>—</td></tr>
        <tr><td class="text-left p-2 text-green-700 font-semibold">✅ Algoritmo com lacunas</td>
          <td>${formatar(tempoTratado)}</td><td>${percentual}%</td><td>${percentual >= 97 ? '✅ Concluída' : '❌ Incompleta'}</td></tr>
        <tr><td class="text-left p-2 text-blue-700 font-semibold">📘 Função SQL atual</td>
          <td>${formatar(sql.segundos_assistidos)}</td><td>${sql.percentual_assistido}%</td><td>${sql.status}</td></tr>
      `;
      document.getElementById('tabelaResultados').innerHTML = linhas;
    });

    document.getElementById('toggleTracking').addEventListener('click', () => {
      grid.classList.toggle('hidden');
      const txt = grid.classList.contains('hidden') ? '👁️ Mostrar Visual de Segmentos' : '🙈 Ocultar Visual de Segmentos';
      document.getElementById('toggleTracking').textContent = txt;
    });

    grid.addEventListener('mouseover', exibirTooltip);
    grid.addEventListener('mouseout', () => tooltip.style.display = 'none');

    carregarDadosIniciais();
  </script>
</body>
</html>
