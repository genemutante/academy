<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Geral de Cursos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }
    h1 {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      max-width: 600px;
      margin: 20px auto;
    }
    canvas {
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <h1>ðŸ“Š Dashboard Geral de Cursos</h1>
  <div class="card" id="resumo"></div>
  <canvas id="graficoMedia" width="400" height="200"></canvas>

  <script>
    const supabase = window.supabase.createClient(
      'https://bkueljjvhijojzcyodvk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrdWVsamp2aGlqb2p6Y3lvZHZrIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0MzUwNTQ4OSwiZXhwIjoyMDU5MDgxNDg5fQ.o-G5KmxoyfQjeNM5e7rbgxpryOHYC9k1OIo9fYzyeYE'
    );

    async function carregarDashboard() {
      const { data, error } = await supabase.rpc('fn_dashboard_cursos');
      if (error) {
        document.getElementById('resumo').innerText = 'Erro ao carregar dados: ' + error.message;
        return;
      }

      const card = document.getElementById('resumo');
      let cursos = [];
      data.forEach((curso) => {
        card.innerHTML += `
          <h3>${curso.curso}</h3>
          <p><b>Alunos:</b> ${curso.alunos}</p>
          <p><b>% MÃ©dio Assistido:</b> ${curso.percentual_medio_assistido.toFixed(1)}%</p>
          <p><b>Taxa de ConclusÃ£o:</b> ${curso.taxa_conclusao.toFixed(1)}%</p>
          <p><b>Taxa de Abandono:</b> ${curso.taxa_abandono.toFixed(1)}%</p>
          <p><b>Tempo MÃ©dio:</b> ${formatarSegundos(curso.tempo_medio)}</p>
          <p><b>SessÃµes por Aula:</b> ${curso.sessoes_por_aula.toFixed(2)}</p>
        `;
        cursos.push({ nome: curso.curso, tempo: curso.tempo_medio });
      });

      renderGraficoMedia(cursos);
    }

    function formatarSegundos(s) {
      const m = Math.floor(s / 60);
      const seg = Math.floor(s % 60);
      return `${m}m ${seg}s`;
    }

    function renderGraficoMedia(cursos) {
      const ctx = document.getElementById('graficoMedia').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: cursos.map(c => c.nome),
          datasets: [{
            label: 'Tempo MÃ©dio (segundos)',
            data: cursos.map(c => c.tempo),
            backgroundColor: '#4dade0'
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    carregarDashboard();
  </script>
</body>
</html>
