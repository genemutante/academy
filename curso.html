<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>T√≠tulo da Aula</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-white text-gray-800 p-6">
  <div class="max-w-3xl mx-auto">
    <a href="javascript:history.back()" class="text-sm text-purple-600 hover:underline block mb-2">‚Üê Voltar</a>
    <h1 id="tituloCurso" class="text-2xl font-bold mb-4">Carregando...</h1>

    <div class="aspect-video w-full rounded overflow-hidden mb-4">
      <iframe id="videoPlayer" class="w-full h-full" frameborder="0" allowfullscreen></iframe>
    </div>

    <div id="statusAula" class="text-sm text-gray-600 space-y-1">
      <p>‚öôÔ∏è Progresso salvo automaticamente durante a reprodu√ß√£o</p>
      <p>‚è±Ô∏è <span id="tempoAssistido">0s</span> / <span id="tempoTotal">0s</span></p>
      <p id="progressoPorcentagem">üìä Progresso: 0%</p>
      <p id="marcadorSegmento" class="text-green-600 hidden">üåü Segmento:</p>
    </div>

    <div id="quizContainer" class="mt-6 hidden">
      <a id="linkQuiz" href="#" class="inline-block bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">
        Fazer Avalia√ß√£o do Curso
      </a>
    </div>
  </div>

  <script>

    const supabase = window.supabase.createClient(
      'https://bkueljjvhijojzcyodvk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrdWVsamp2aGlqb2p6Y3lvZHZrIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0MzUwNTQ4OSwiZXhwIjoyMDU5MDgxNDg5fQ.o-G5KmxoyfQjeNM5e7rbgxpryOHYC9k1OIo9fYzyeYE'
    );
    

    const url = new URL(window.location.href);
    const user_id = url.searchParams.get('user_id');
    let course_id = url.searchParams.get('course_id');

    const tituloCurso = document.getElementById('tituloCurso');
    const videoPlayer = document.getElementById('videoPlayer');
    const tempoAssistido = document.getElementById('tempoAssistido');
    const tempoTotal = document.getElementById('tempoTotal');
    const progressoPorcentagem = document.getElementById('progressoPorcentagem');
    const marcadorSegmento = document.getElementById('marcadorSegmento');

    async function fallbackBuscarCurso() {
      console.warn('[Fallback] Buscando curso para usu√°rio', user_id);

      let { data: cursoUsuario } = await supabase
        .from('courses')
        .select('id')
        .eq('created_by', user_id)
        .limit(1)
        .maybeSingle();

      if (cursoUsuario) return cursoUsuario.id;

      let { data: cursoRecente } = await supabase
        .from('courses')
        .select('id')
        .order('created_at', { ascending: false })
        .limit(1)
        .maybeSingle();

      return cursoRecente?.id || null;
    }

    async function init() {
      if (!course_id) {
        course_id = await fallbackBuscarCurso();
      }

      if (!course_id) {
        tituloCurso.textContent = 'Nenhum curso encontrado.';
        alert('‚ö†Ô∏è Nenhum curso foi atribu√≠do a este aluno ainda.');
        throw new Error('course_id n√£o p√¥de ser determinado');
      }

      const { data: curso } = await supabase.from('courses').select('*').eq('id', course_id).single();
      tituloCurso.textContent = curso?.title || 'T√≠tulo da Aula';

      const { data: aulas } = await supabase.from('lessons').select('*').eq('course_id', course_id).order('order');
      const aula = aulas?.[0];

      if (!aula) {
        alert('‚ö†Ô∏è Nenhuma aula encontrada.');
        return;
      }

      const match = aula.youtube_url.match(/(?:v=|\/embed\/|\.be\/)([a-zA-Z0-9_-]{11})/);
      const videoId = match ? match[1] : '';
      videoPlayer.src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1`;

      tempoTotal.textContent = aula.duration + 's';
    }

    init();
  </script>
</body>
</html>
