<button
  class="bg-blue-600 text-white font-bold py-2 px-4 rounded shadow hover:bg-blue-700 transition"
  onclick="
    (async () => {
      console.log('🚀 Iniciando rotina de atualização de progresso...');

      const uid = window.user_id;
      const cid = window.course_id;
      const supa = window.supabase;

      console.log('🔍 Variáveis detectadas:', { uid, cid, supa });

      if (!uid || !cid || !supa || typeof supa.from !== 'function') {
        console.error('❌ Supabase mal definido ou funções indisponíveis');
        alert('❌ Supabase inválido. Certifique-se de que foi inicializado corretamente.');
        return;
      }

      try {
        console.log('📡 Buscando todas as aulas...');
        const { data: aulas, error: erroAulas } = await supa
          .from('aulas')
          .select('id')
          .eq('curso_id', cid);

        if (erroAulas) throw new Error('Erro ao consultar aulas: ' + erroAulas.message);

        console.log('📚 Aulas encontradas:', aulas);

        console.log('📡 Buscando aulas concluídas do aluno...');
        const { data: concluidas, error: erroConclusao } = await supa
          .from('progresso_aulas')
          .select('id_aula')
          .eq('id_aluno', uid)
          .eq('id_curso', cid)
          .eq('concluida', true);

        if (erroConclusao) throw new Error('Erro ao consultar progresso: ' + erroConclusao.message);

        const total = aulas?.length || 0;
        const feitas = concluidas?.length || 0;
        const percentual = total > 0 ? Math.round((feitas / total) * 100) : 0;

        console.log(`📊 ${feitas} de ${total} aulas concluídas (${percentual}%)`);

        const barra = document.getElementById('barraProgresso');
        const texto = document.getElementById('textoProgresso');

        if (barra) barra.style.width = percentual + '%';
        if (texto) texto.textContent = `${percentual}%`;

        alert(`✅ Progresso atualizado: ${feitas}/${total} (${percentual}%)`);
      } catch (e) {
        console.error('🔥 Erro durante atualização:', e);
        alert('❌ Falha ao atualizar progresso.\n\n' + (e.message || JSON.stringify(e)));
      }

      console.log('🏁 Rotina finalizada.');
    })();
  "
>
  🔄 Atualizar Progresso
</button>
