<button
  class="bg-blue-600 text-white font-bold py-2 px-4 rounded shadow hover:bg-blue-700 transition"
  onclick="
    (async () => {
      console.log('ğŸš€ Iniciando rotina de atualizaÃ§Ã£o de progresso...');

      const uid = window.user_id;
      const cid = window.course_id;
      const supa = window.supabase;

      console.log('ğŸ” VariÃ¡veis detectadas:', { uid, cid, supa });

      if (!uid || !cid || !supa || typeof supa.from !== 'function') {
        console.error('âŒ Supabase mal definido ou funÃ§Ãµes indisponÃ­veis');
        alert('âŒ Supabase invÃ¡lido. Certifique-se de que foi inicializado corretamente.');
        return;
      }

      try {
        console.log('ğŸ“¡ Buscando todas as aulas...');
        const { data: aulas, error: erroAulas } = await supa
          .from('aulas')
          .select('id')
          .eq('curso_id', cid);

        if (erroAulas) throw new Error('Erro ao consultar aulas: ' + erroAulas.message);

        console.log('ğŸ“š Aulas encontradas:', aulas);

        console.log('ğŸ“¡ Buscando aulas concluÃ­das do aluno...');
        const { data: concluidas, error: erroConclusao } = await supa
          .from('progresso_aulas')
          .select('id_aula')
          .eq('id_aluno', uid)
          .eq('id_curso', cid)
          .eq('concluida', true);

        if (erroConclusao) throw new Error('Erro ao consultar progresso: ' + erroConclusao.message);

        const total = aulas?.length || 0;
        const feitas = concluidas?.length || 0;
        const percentual = total > 0 ? Math.round((feitas / total) * 100) : 0;

        console.log(`ğŸ“Š ${feitas} de ${total} aulas concluÃ­das (${percentual}%)`);

        const barra = document.getElementById('barraProgresso');
        const texto = document.getElementById('textoProgresso');

        if (barra) barra.style.width = percentual + '%';
        if (texto) texto.textContent = `${percentual}%`;

        alert(`âœ… Progresso atualizado: ${feitas}/${total} (${percentual}%)`);
      } catch (e) {
        console.error('ğŸ”¥ Erro durante atualizaÃ§Ã£o:', e);
        alert('âŒ Falha ao atualizar progresso.\n\n' + (e.message || JSON.stringify(e)));
      }

      console.log('ğŸ Rotina finalizada.');
    })();
  "
>
  ğŸ”„ Atualizar Progresso
</button>
