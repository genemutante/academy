<script type="module">
  import { verificarLoginObrigatorio, logout } from './js/bootstrap.js';
  import { supabase } from './js/supabaseClient.js'; // üîÅ Corrigido: importar Supabase diretamente

  (async () => {
    const sessao = await verificarLoginObrigatorio();
    if (!sessao) return;

    const userId = sessao.userId;
    const userName = sessao.userName;

    document.getElementById('aluno-nome').textContent = userName;
    document.getElementById('aluno-nome-saudacao').textContent = userName;

    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', logout);
    }

    const { data, error } = await supabase
      .from('user_courses')
      .select('course_id, courses (id, title, description)')
      .eq('user_id', userId);

    const container = document.getElementById('cursos');

    if (error || !data?.length) {
      container.innerHTML = `<p class="text-gray-500">Nenhum curso dispon√≠vel no momento.</p>`;
      return;
    }

    container.innerHTML = '';
    data.forEach(entry => {
      const curso = entry.courses;
      if (!curso) return;

      const card = document.createElement('div');
      card.className = 'bg-white rounded-xl shadow-sm border p-5 hover:shadow-md transition';
      card.innerHTML = `
        <h3 class="text-lg font-semibold text-primary-700 mb-1">${curso.title}</h3>
        <p class="text-sm text-gray-600 mb-3">${curso.description || 'Sem descri√ß√£o dispon√≠vel.'}</p>
        <button
          class="abrir-curso inline-block bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded text-sm font-medium transition"
          data-id="${curso.id}"
          data-nome="${curso.title}"
        >
          Acessar curso
        </button>
      `;
      container.appendChild(card);
    });

    // üîç Evento de clique no container (delega√ß√£o)
    container.addEventListener('click', (e) => {
      const botao = e.target.closest('.abrir-curso');
      if (!botao) return;

      const id = botao.dataset.id;
      const nome = botao.dataset.nome;

      console.log(`üß≠ Curso selecionado: ${nome} (ID ${id})`);
      sessionStorage.setItem('log_debug', `Acessando curso "${nome}" (ID: ${id}) √†s ${new Date().toISOString()}`);

      window.location.href = `curso.html?course_id=${id}`;
    });
  })();
</script>
