

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Avaliação da Aula</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
  <style> 
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Outfit:wght@300;400;600&display=swap');
    body { font-family: 'Outfit', sans-serif; }
    .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    .option-card { transition: all 0.2s ease; border: 2px solid #f1f5f9; cursor: pointer; }
    .option-card:hover { border-color: #3B82F6; background: #EFF6FF; }
    .option-card.selected { border-color: #2563EB; background: #DBEAFE; font-weight: 600; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">

  <div id="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-white">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
  </div>

  <div class="max-w-2xl mx-auto px-4 py-8">
    <div id="quiz-container" class="hidden">
      <div class="mb-8 text-center">
        <h1 id="lesson-title" class="text-2xl font-bold text-slate-800 font-['Nunito'] mb-2">Avaliação da Aula</h1>
        <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
          <div id="progress-bar" class="bg-blue-600 h-full w-0 transition-all duration-500"></div>
        </div>
        <p id="step-indicator" class="text-sm text-slate-500 mt-2 font-medium">Pergunta 1 de ...</p>
      </div>

      <div class="glass-card rounded-3xl p-8 shadow-xl border border-white mb-6">
        <div id="question-content">
          <h2 id="question-text" class="text-xl text-slate-800 font-semibold mb-6">A carregar pergunta...</h2>
          <div id="options-container" class="space-y-3"></div>
        </div>
      </div>

      <div class="flex justify-between items-center">
        <button id="btn-back" class="px-6 py-3 text-slate-600 font-semibold hover:bg-slate-100 rounded-xl transition invisible">Voltar</button>
        <button id="btn-next" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-200 hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>Avançar</button>
      </div>
    </div>
  </div>

  <script type="module">
    // --- CONFIGURAÇÃO SUPABASE ---
    const SUPABASE_URL = 'https://hiigckoowkrpewlybfef.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhpaWdja29vd2tycGV3bHliZmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTc3NzIsImV4cCI6MjA4MzI5Mzc3Mn0.b5Uf3GXkE_jOVE0J1h3ssWdldiFjm6qQ1yUZr_Mu3Oo';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let questions = [];
    let currentStep = 0;
    let userAnswers = {};
    let quizId = null; // Guardar o ID do Quiz para salvar depois
    
    const params = new URLSearchParams(window.location.search);
    const userId = params.get('user_id');
    const lessonId = params.get('lesson_id');

    async function initQuiz() {
      if (!lessonId || lessonId === "false") {
        showError("ID da aula inválido.");
        return;
      }

      try {
        // 1. Achar o Quiz vinculado a esta Aula (context_id)
        const { data: quizData, error: quizError } = await _supabase
          .from('quizzes')
          .select('id')
          .eq('context_id', lessonId)
          .single();

        if (quizError || !quizData) throw new Error("Quiz não encontrado para esta aula.");
        quizId = quizData.id;

        // 2. Buscar perguntas e opções desse Quiz específico
        const { data, error } = await _supabase
          .from('questions')
          .select(`
            id,
            text,
            options ( id, text, is_correct )
          `)
          .eq('quiz_id', quizId);

        if (error) throw error;
        if (!data || data.length === 0) throw new Error("Nenhuma pergunta encontrada.");

        // Formatar os dados para o quiz
        questions = data;
        renderStep();
      } catch (err) {
        showError(err.message);
      } finally {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('quiz-container').classList.remove('hidden');
      }
    }

    function renderStep() {
      const question = questions[currentStep];
      const container = document.getElementById('options-container');
      
      document.getElementById('question-text').textContent = question.text;
      document.getElementById('step-indicator').textContent = `Pergunta ${currentStep + 1} de ${questions.length}`;
      document.getElementById('progress-bar').style.width = `${((currentStep + 1) / questions.length) * 100}%`;
      
      container.innerHTML = '';
      
      question.options.forEach((opt) => {
        const card = document.createElement('div');
        const isSelected = userAnswers[currentStep] === opt.id;
        card.className = `option-card p-4 rounded-2xl border-2 ${isSelected ? 'selected' : ''}`;
        card.innerHTML = `${opt.text}`;
        card.onclick = () => {
          userAnswers[currentStep] = opt.id;
          renderStep();
        };
        container.appendChild(card);
      });

      document.getElementById('btn-back').classList.toggle('invisible', currentStep === 0);
      const btnNext = document.getElementById('btn-next');
      btnNext.textContent = currentStep === questions.length - 1 ? 'Finalizar' : 'Avançar';
      btnNext.disabled = !userAnswers[currentStep];
    }

    async function submitQuiz() {
      document.getElementById('loading').classList.remove('hidden');
      
      // Cálculo de Acertos baseado no ID da opção correta
      const correctCount = questions.reduce((acc, q, idx) => {
        const selectedOptId = userAnswers[idx];
        const isCorrect = q.options.find(o => o.id === selectedOptId)?.is_correct;
        return acc + (isCorrect ? 1 : 0);
      }, 0);

      const scorePercent = Math.round((correctCount / questions.length) * 100);

      try {
        const { error } = await _supabase
          .from('user_quiz_results')
          .insert({
            user_id: userId,
            lesson_id: lessonId,
            quiz_id: quizId, // Importante gravar o ID do Quiz
            score: scorePercent,
            answers: userAnswers
          });

        if (error) throw error;

        alert(`Avaliação concluída! Acertou ${scorePercent}% das questões.`);
        window.parent.postMessage({ type: 'QUIZ_COMPLETE', lessonId, score: scorePercent }, '*');
        
      } catch (err) {
        alert("Erro ao guardar o resultado: " + err.message);
      } finally {
        document.getElementById('loading').classList.add('hidden');
      }
    }

    function showError(msg) {
      document.getElementById('quiz-container').innerHTML = `<div class="text-center p-8 bg-red-50 text-red-700 rounded-3xl">⚠️ ${msg}</div>`;
      document.getElementById('quiz-container').classList.remove('hidden');
      document.getElementById('loading').classList.add('hidden');
    }

    document.getElementById('btn-next').onclick = () => {
      if (currentStep < questions.length - 1) { currentStep++; renderStep(); } 
      else submitQuiz();
    };
    document.getElementById('btn-back').onclick = () => { if (currentStep > 0) { currentStep--; renderStep(); } };

    initQuiz();
  </script>
</body>
</html>
