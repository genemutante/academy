<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Como o aluno assistiu essa aula?</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.5/dist/umd/supabase.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Carlito&display=swap" rel="stylesheet">

  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0f4f8',
              100: '#d9e2ec',
              200: '#bcccdc',
              300: '#9fb3c8',
              400: '#829ab1',
              500: '#627d98',
              600: '#486581',
              700: '#334e68',
              800: '#243b53',
              900: '#102a43'
            },
            success: {
              100: '#d1fae5',
              300: '#6ee7b7',
              500: '#10b981',
              700: '#047857'
            },
            warning: {
              100: '#fef3c7',
              300: '#fcd34d',
              500: '#f59e0b'
            },
            danger: {
              100: '#fee2e2',
              300: '#fca5a5',
              500: '#ef4444',
              700: '#b91c1c'
            },
            info: {
              100: '#dbeafe',
              300: '#93c5fd',
              500: '#3b82f6'
            },
            slate: tailwind.colors.slate,
            gray: tailwind.colors.gray,
          },
fontFamily: {
  sans: ['Carlito', 'sans-serif'],
}

        }
      }
    };
  </script>
  
  <style>
    @media (min-width: 1024px) {
      .painel-fixo {
        position: sticky;
        top: 1rem;
        align-self: start;
      }
    }
    @media print {
      .print-visible {
        page-break-before: always;
      }
      .print-visible, .print-visible * {
        visibility: visible;
      }
      .print-visible {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        padding: 2rem;
        background: white;
      }
      .painel-fixo {
        position: static !important;
        box-shadow: none !important;
      }
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 p-6 font-sans">


<div class="max-w-6xl mx-auto">
  <h1 class="text-2xl font-bold text-primary-800 mb-2">Como o aluno assistiu essa aula?</h1>
  <p class="text-sm text-gray-600 mb-6">Entenda visualmente a jornada do aluno durante o v√≠deo. Cada quadradinho representa 1 segundo.</p>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end mb-4">
    <div>
      <label class="block font-semibold mb-1">Aluno</label>
      <select id="aluno" class="w-full p-2 border border-gray-300 rounded"></select>
    </div>
    <div>
      <label class="block font-semibold mb-1">Curso</label>
      <select id="curso" class="w-full p-2 border border-gray-300 rounded"></select>
    </div>
    <div>
      <label class="block font-semibold mb-1">Aula</label>
      <select id="aula" class="w-full p-2 border border-gray-300 rounded"></select>
    </div>
    <button id="btn" class="bg-primary-700 hover:bg-primary-800 text-white px-4 py-2 rounded shadow">

      Calcular Progresso
    </button>
  </div>

  <div id="resultado" class="mt-8 hidden">
    <div class="mb-3 text-sm text-gray-700">
      <strong>Legenda:</strong>
      <div class="flex flex-wrap gap-x-4 gap-y-1 mt-1">
        <div class="flex items-center gap-1"><div class="w-4 h-4 bg-blue-400 rounded-sm"></div> Assistido 1x</div>
        <div class="flex items-center gap-1"><div class="w-4 h-4 bg-emerald-400 rounded-sm"></div> Assistido +1x</div>
        <div class="flex items-center gap-1"><div class="w-4 h-4 bg-gray-200 border border-gray-400 rounded-sm"></div> N√£o assistido</div>
        <div class="flex items-center gap-1"><div class="w-4 h-4 bg-gray-800 rounded-sm"></div> Fora da aula</div>
      </div>
    </div>

    <div id="painel"
      class="bg-neutral-900 pt-10 pb-10 px-4 rounded shadow overflow-hidden mx-auto"
      style="display: grid; grid-template-columns: repeat(120, minmax(4px, 1fr)); gap: 1px; max-width: 100%;">
    </div>

    <div id="bloco-diagnostico" class="mt-6"></div>

    <p class="text-sm text-left mt-4">
      <a href="#" onclick="document.getElementById('detalhes').classList.toggle('hidden')" class="text-blue-700 underline">
        Mostrar/Ocultar Detalhes
      </a>
    </p>

    <div id="detalhes"
     class="hidden mt-6 mx-auto grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-3 text-sm font-mono max-w-6xl">
    </div>
  </div>
</div>

<script>
const supabase = window.supabase.createClient(
  'https://bkueljjvhijojzcyodvk.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrdWVsamp2aGlqb2p6Y3lvZHZrIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0MzUwNTQ4OSwiZXhwIjoyMDU5MDgxNDg5fQ.o-G5KmxoyfQjeNM5e7rbgxpryOHYC9k1OIo9fYzyeYE'
);


const CONCEITOS = [
  { sigla: "A", notaMin: 9.5, rubrica: "Excelente", bncc: "Alcan√ßou com excel√™ncia os objetivos da aula.", feedback: "Desempenho excepcional. Continue nesse ritmo!" },
  { sigla: "B+", notaMin: 9.0, rubrica: "Muito bom", bncc: "Alcan√ßou os objetivos com qualidade.", feedback: "√ìtimo trabalho, com envolvimento acima da m√©dia." },
  { sigla: "B", notaMin: 7.5, rubrica: "Bom", bncc: "Alcan√ßou os objetivos com qualidade, com espa√ßo para evoluir.", feedback: "Bom desempenho, mas com pontos a fortalecer." },
  { sigla: "C", notaMin: 6.0, rubrica: "Regular", bncc: "Alcan√ßou parcialmente os objetivos propostos.", feedback: "Pode mais. Reforce o foco nos pr√≥ximos conte√∫dos." },
  { sigla: "D", notaMin: 4.0, rubrica: "Insuficiente", bncc: "Apresenta dificuldades em consolidar os objetivos.", feedback: "Engajamento baixo. Requer maior aten√ß√£o." },
  { sigla: "E", notaMin: 0.0, rubrica: "Fraco", bncc: "N√£o alcan√ßou os objetivos esperados da aula.", feedback: "Baix√≠ssimo aproveitamento. Necessita interven√ß√£o." }
];

function gerarNotaEConceito(d) {
  let notaBase = d.percentualAssistido / 10;
  let penalidade = 0;
  let bonus = 0;

  if (!d.inicioAssistido) penalidade += 0.5;
  if (!d.fimAssistido) penalidade += 0.5;
  if (d.percentualLacunas > 0.25) penalidade += 1;
  if (d.maiorLacuna > 60) penalidade += 0.5;
  if (d.totalLacunas >= 4) penalidade += 0.5;
  if (!d.linearidade && d.percentualAssistido < 80) penalidade += 0.5;
  if (d.finalizouForaDoPrazo) penalidade += 0.5;
  if (d.duracaoDias > 10 && d.percentualAssistido < 100) penalidade += 0.5;

  if (d.percentualAssistido >= 90 && d.totalRepeticoes >= 30) bonus += 0.5;
  if (d.totalSessoes === 1 && d.percentualAssistido >= 90) bonus += 0.3;

  const notaFinal = Math.max(0, Math.min(10, notaBase - penalidade + bonus));
  const conceitoData = CONCEITOS.find(c => notaFinal >= c.notaMin);

  return {
    nota: notaFinal.toFixed(1).replace('.', ','),
    conceito: conceitoData.sigla,
    rubrica: conceitoData.rubrica,
    feedback: conceitoData.feedback,
    bncc: conceitoData.bncc
  };
}

  

function gerarDiagnosticoCompleto({ heatmap, duracao, lacunas, segmentos }) {
  const percentualAssistido = Math.round((heatmap.filter((v, i) => v > 0 && i < duracao).length / duracao) * 100);
  const totalRepeticoes = heatmap.filter(v => v > 1).length;
  const inicioAssistido = heatmap.slice(0, 10).some(v => v > 0);
  const fimAssistido = heatmap.slice(duracao - 10, duracao).some(v => v > 0);
  const totalLacunas = lacunas.length;
  const maiorLacuna = lacunas.length ? Math.max(...lacunas.map(([ini, fim]) => fim - ini + 1)) : 0;
  const percentualLacunas = lacunas.reduce((acc, [ini, fim]) => acc + (fim - ini + 1), 0) / duracao;
  const ordemOriginal = segmentos.map(s => s.segment.start);
  const linearidade = ordemOriginal.every((v, i, arr) => i === 0 ? true : v >= arr[i - 1]);
  const datas = segmentos.map(s => new Date(s.created_at).getTime()).sort();
  const dataInicio = new Date(datas[0]);
  const dataFim = new Date(datas[datas.length - 1]);
  const duracaoDias = Math.ceil((dataFim - dataInicio) / (1000 * 60 * 60 * 24));
  let totalSessoes = 1;
  for (let i = 1; i < datas.length; i++) {
    const diff = (datas[i] - datas[i - 1]) / (1000 * 60);
    if (diff > 60) totalSessoes++;
  }
  const prazoLimite = new Date(dataInicio);
  prazoLimite.setDate(prazoLimite.getDate() + 7);
  const finalizouForaDoPrazo = dataFim > prazoLimite;

  return {
    percentualAssistido,
    totalRepeticoes,
    inicioAssistido,
    fimAssistido,
    totalLacunas,
    maiorLacuna,
    percentualLacunas,
    linearidade,
    dataInicio,
    dataFim,
    duracaoDias,
    prazoLimite,
    finalizouForaDoPrazo,
    totalSessoes
  };
}

function gerarParecerTutor(d, a) {
  const mensagens = [];

  // Avalia se a aula est√° em andamento
  const emAndamento = d.percentualAssistido < 100 && !d.finalizouForaDoPrazo;
  const status = emAndamento ? "preliminar" : "definitivo";

  // Bloco de aviso para parecer parcial
  if (emAndamento) {
    mensagens.push("Esta aula ainda est√° em andamento. O parecer √© preliminar e pode mudar conforme o aluno avan√ßa.");
  }

  // Bloco: abertura conforme conceito
  if (a.conceito === "A") {
    mensagens.push(random([
      "O aluno apresentou desempenho excepcional e foco cont√≠nuo.",
      "A aula foi acompanhada integralmente, do in√≠cio ao fim.",
      "Visualiza√ß√£o completa e excelente dedica√ß√£o ao conte√∫do."
    ]));
  } else if (a.conceito === "B+") {
    mensagens.push(random([
      "O aluno demonstrou engajamento alto, com leve margem de progresso.",
      "Quase toda a aula foi assistida com aten√ß√£o constante.",
      "Alto envolvimento, com √≥tima presen√ßa nos pontos-chave."
    ]));
  } else if (a.conceito === "B") {
    mensagens.push(random([
      "O aluno acompanhou a maior parte da aula com aten√ß√£o razo√°vel.",
      "Engajamento consistente, mas com interrup√ß√µes pontuais.",
      "Aula vista de forma significativa, com espa√ßo para refinamento."
    ]));
  } else if (a.conceito === "C") {
    mensagens.push(random([
      "O aluno acompanhou parcialmente a aula, com perdas relevantes.",
      "Presen√ßa parcial, que pode comprometer a consolida√ß√£o do conte√∫do.",
      "Envolvimento limitado ‚Äî pode mais com foco e const√¢ncia."
    ]));
  } else if (a.conceito === "D") {
    mensagens.push(random([
      emAndamento
        ? "O aproveitamento at√© o momento est√° abaixo do ideal, mas ainda pode evoluir."
        : "Engajamento insuficiente e presen√ßa comprometida.",
      "A aula foi pouco explorada pelo aluno.",
      "Baixo aproveitamento, com necessidade de maior dedica√ß√£o."
    ]));
  } else if (a.conceito === "E") {
    mensagens.push(random([
      emAndamento
        ? "Ainda n√£o houve progresso significativo nesta aula."
        : "Aula n√£o foi acompanhada de forma significativa.",
      "Praticamente n√£o houve engajamento com o conte√∫do.",
      "Aproveitamento muito baixo ‚Äî precisa de acompanhamento."
    ]));
  }

  // Bloco: in√≠cio/fim ignorado
  if (!d.inicioAssistido) mensagens.push("Os primeiros minutos da aula foram ignorados.");
  if (!d.fimAssistido) mensagens.push("A aula foi encerrada antes do t√©rmino esperado.");

  // Bloco: lacunas
  if (d.maiorLacuna > 60) mensagens.push("Uma ou mais lacunas longas foram detectadas.");
  if (d.totalLacunas >= 3 && d.percentualAssistido >= 60)
    mensagens.push("Interrup√ß√µes frequentes ao longo da aula.");
  if (d.percentualLacunas > 0.3)
    mensagens.push("Uma parte significativa da aula foi ignorada.");

  // Bloco: repeti√ß√µes
  if (d.totalRepeticoes > 30) mensagens.push("V√°rios trechos foram revistos ‚Äî pode indicar d√∫vida ou interesse.");

  // Bloco: linearidade
  if (!d.linearidade && d.percentualAssistido > 60)
    mensagens.push("O conte√∫do foi consumido com saltos e retomadas.");

  // Bloco: prazo e tempo
  if (d.finalizouForaDoPrazo)
    mensagens.push("A aula foi finalizada ap√≥s o prazo de 7 dias recomendado.");
  if (d.duracaoDias >= 10 && d.percentualAssistido < 100)
    mensagens.push(`O aluno levou ${d.duracaoDias} dias para concluir parcialmente a aula.`);

  // Bloco: sess√µes
  if (d.totalSessoes >= 3)
    mensagens.push("O conte√∫do foi dividido em v√°rias sess√µes, com retomadas espa√ßadas.");
  else if (d.totalSessoes === 1 && d.percentualAssistido >= 90)
    mensagens.push("A aula foi assistida de forma cont√≠nua e objetiva.");

// Bloco: recomenda√ß√£o extra
if (a.conceito === 'D' || a.conceito === 'E') {
  mensagens.push("üìö Recomenda-se revisar os materiais e buscar apoio do tutor.");
}


  
  return {
    texto: mensagens.join(" "),
    status // "preliminar" ou "definitivo"
  };
}


  

const MAX_SEGUNDOS = 60 * 60;
const alunoSel = document.getElementById('aluno');
const cursoSel = document.getElementById('curso');
const aulaSel = document.getElementById('aula');
const btn = document.getElementById('btn');
const painel = document.getElementById('painel');
const detalhes = document.getElementById('detalhes');
const resultado = document.getElementById('resultado');

function formatar(seg) {
  const h = String(Math.floor(seg / 3600)).padStart(2, '0');
  const m = String(Math.floor((seg % 3600) / 60)).padStart(2, '0');
  const s = String(seg % 60).padStart(2, '0');
  return `${h}h${m}m${s}s`;
}

function random(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}
function gerarParecerModularizado(porcentagem, lacunas, repeticoes, inicio, fim, duracao) {
  const mensagens = [];

  if (porcentagem >= 97 && lacunas.length === 0) {
    mensagens.push(random([
      "üéØ Aula assistida por completo com aten√ß√£o cont√≠nua.",
      "‚úÖ Excelente foco durante toda a aula.",
      "üëè Desempenho exemplar ‚Äî visualizou tudo com consist√™ncia."
    ]));
  } else if (porcentagem >= 90) {
    mensagens.push(random([
      "üìò A maior parte da aula foi assistida com aten√ß√£o.",
      "üìó Engajamento acima da m√©dia, com poucas perdas.",
      "üîç Conte√∫do absorvido quase totalmente."
    ]));
  } else if (porcentagem >= 75) {
    mensagens.push(random([
      "‚ö†Ô∏è O aluno demonstrou esfor√ßo, mas com algumas interrup√ß√µes.",
      "üìí Participa√ß√£o razo√°vel, apesar de algumas aus√™ncias.",
      "üìå Aula assistida parcialmente, com sinais de aten√ß√£o."
    ]));
  } else if (porcentagem >= 50) {
    mensagens.push(random([
      "üöß O aluno assistiu menos da metade da aula.",
      "üîª Houve muitas lacunas no acompanhamento do conte√∫do.",
      "üòï Engajamento abaixo do ideal."
    ]));
  } else {
    mensagens.push(random([
      "‚ùå Pouco engajamento detectado.",
      "üü• A aula foi ignorada quase por completo.",
      "üìâ Desempenho insuficiente ‚Äî aten√ß√£o quase nula."
    ]));
  }

  if (lacunas.some(([ini, fim]) => fim - ini > 60)) mensagens.push("‚è≥ Uma ou mais lacunas longas foram detectadas.");
  if (lacunas.length >= 3 && porcentagem >= 60) mensagens.push("üß© V√°rias interrup√ß√µes curtas ao longo da aula.");
  if (inicio === 0 && fim === 0) mensagens.push("üìç Ignorou tanto o in√≠cio quanto o final da aula.");
  else {
    if (inicio > 0) mensagens.push("üîé Ignorou os primeiros minutos da aula.");
    if (fim === 0) mensagens.push("‚èπÔ∏è Parou antes da aula terminar.");
  }
  if (repeticoes > 30) mensagens.push("üß† Muitos trechos foram revistos ‚Äî pode indicar d√∫vida ou interesse.");
  if (repeticoes === 0 && porcentagem > 85) mensagens.push("üéØ Engajamento direto, sem revis√µes. Objetivo e linear.");

  if (porcentagem >= 90) mensagens.push(random([
    "üöÄ √ìtimo sinal de comprometimento.",
    "üôå Excelente envolvimento, continue assim!",
    "üéì Demonstra responsabilidade com o aprendizado."
  ]));
  else if (porcentagem >= 60) mensagens.push(random([
    "üí° H√° potencial, mas aten√ß√£o aos detalhes √© importante.",
    "üìà Boa base, mas pode melhorar com mais foco.",
    "üõ†Ô∏è Engajamento aceit√°vel, com margem de progresso."
  ]));
  else mensagens.push(random([
    "üì¢ √â preciso mais dedica√ß√£o nos pr√≥ximos conte√∫dos.",
    "üß≠ Aten√ß√£o necess√°ria para evoluir no aprendizado.",
    "üö® Recomendado refor√ßo e reavalia√ß√£o da abordagem."
  ]));

  return mensagens.join(" ");
}

function gerarAvaliacaoTecnica(percentual) {
  let nota = Math.round(percentual) / 10;
  let conceito, rubrica, bncc, feedback;

  if (percentual >= 90) {
    conceito = "A";
    rubrica = "Excelente";
    bncc = "Alcan√ßou totalmente";
    feedback = "Excelente envolvimento. Est√° no caminho certo.";
  } else if (percentual >= 75) {
    conceito = "B";
    rubrica = "Bom";
    bncc = "Alcan√ßou com qualidade";
    feedback = "Bom desempenho, com margem para melhorar.";
  } else if (percentual >= 60) {
    conceito = "C";
    rubrica = "Regular";
    bncc = "Alcan√ßou parcialmente";
    feedback = "Pode mais! Refor√ßar foco nos pr√≥ximos conte√∫dos.";
  } else if (percentual >= 40) {
    conceito = "D";
    rubrica = "Insuficiente";
    bncc = "Alcan√ßou de forma limitada";
    feedback = "Precisa de mais foco e acompanhamento.";
  } else {
    conceito = "E";
    rubrica = "Fraco";
    bncc = "N√£o alcan√ßou";
    feedback = "Baixo aproveitamento. Requer interven√ß√£o.";
  }

  return {
    nota: nota.toFixed(1).replace('.', ','),
    conceito,
    rubrica,
    bncc,
    feedback
  };
}
async function carregar() {
  const { data: alunos } = await supabase.from('users').select('id, name');
  alunoSel.innerHTML = alunos.map(u => `<option value="${u.id}">${u.name}</option>`).join('');

  const { data: cursos } = await supabase.from('courses').select('id, title');
  cursoSel.innerHTML = cursos.map(c => `<option value="${c.id}">${c.title}</option>`).join('');

  cursoSel.addEventListener('change', carregarAulas);
  carregarAulas();
}

async function carregarAulas() {
  const { data: aulas } = await supabase.from('lessons').select('id, title').eq('course_id', cursoSel.value);
  aulaSel.innerHTML = aulas.map(a => `<option value="${a.id}">${a.title}</option>`).join('');
}

btn.addEventListener('click', async () => {
  painel.innerHTML = '';
  detalhes.innerHTML = '';
  resultado.classList.add('hidden');

  const { data: aula } = await supabase.from('lessons').select('duration').eq('id', aulaSel.value).single();
  const duracao = aula.duration;

  const { data: bruto } = await supabase
    .from('progress_segments')
    .select('segment, created_at')
    .eq('user_id', alunoSel.value)
    .eq('lesson_id', aulaSel.value);

  const heatmap = Array(MAX_SEGUNDOS).fill(0);
  bruto.forEach(r => {
    const { start, end } = r.segment;
    if (start >= 0 && end > start && end - start <= 600) {
      for (let s = start; s < end && s < MAX_SEGUNDOS; s++) {
        heatmap[s]++;
      }
    }
  });

  let assistido = 0, repeticoes = 0;
  const blocos = heatmap.map((qtd, idx) => {
    let bg = 'bg-gray-200 border border-gray-400';
    if (idx >= duracao) {
      bg = 'bg-gray-800';
    } else if (qtd === 0) {
      bg = 'bg-gray-200 border border-gray-400';
    } else if (qtd === 1) {
      assistido++;
      bg = 'bg-info-500';
    } else {
      assistido++;
      repeticoes++;
      bg = 'bg-success-500';
    }

    return `<div class="w-2 h-2 ${bg} border border-black/10 rounded-sm relative group">
      <div class="absolute opacity-0 group-hover:opacity-100 transition-opacity duration-200 
                  text-xs text-gray-800 bg-white px-2 py-1 rounded border shadow 
                  -top-6 left-1/2 -translate-x-1/2 whitespace-nowrap z-50 pointer-events-none">
        Minuto ${Math.floor(idx / 60)}:${String(idx % 60).padStart(2, '0')} ‚Äì ${qtd === 0 ? 'N√£o assistido' : qtd === 1 ? 'Visto 1x' : `Visto ${qtd}x`}
      </div>
    </div>`;
  });

  painel.innerHTML = blocos.join('');


  resultado.classList.remove('hidden');

  const segundosAssistidos = heatmap.filter(s => s > 0 && s < 999).length;
  const percentual = Math.round((segundosAssistidos / duracao) * 100);

  const lacunas = [];
  let emLacuna = false, inicioLacuna = 0;
  for (let i = 0; i < duracao; i++) {
    if (heatmap[i] === 0 && !emLacuna) {
      inicioLacuna = i;
      emLacuna = true;
    } else if (heatmap[i] > 0 && emLacuna) {
      lacunas.push([inicioLacuna, i - 1]);
      emLacuna = false;
    }
  }
  if (emLacuna) lacunas.push([inicioLacuna, duracao - 1]);

  // LIMPA parecer antigo, se houver
  resultado.querySelectorAll('.avaliacao-completa').forEach(el => el.remove());



  // Avalia√ß√£o T√©cnica
  const diagnostico = gerarDiagnosticoCompleto({ heatmap, duracao, lacunas, segmentos: bruto });
  const avaliacao = gerarNotaEConceito(diagnostico);
  
  // Parecer
  const parecerTutor = gerarParecerTutor(diagnostico, avaliacao);

const tituloPainel = {
  "A": "Desempenho Excelente",
  "B+": "√ìtimo Desempenho",
  "B": "Bom Aproveitamento",
  "C": "Aten√ß√£o Necess√°ria",
  "D": "Aten√ß√£o Cr√≠tica",
  "E": "Baix√≠ssimo Aproveitamento"
}[avaliacao.conceito] || "Parecer T√©cnico do Tutor";

const corDominante = {
  "A": "#059669",      // Verde
  "B+": "#10b981",     // Verde-claro
  "B": "#f59e0b",      // Amarelo
  "C": "#f59e0b",      // Amarelo
  "D": "#ef4444",      // Vermelho
  "E": "#b91c1c"       // Vermelho-escuro
}[avaliacao.conceito] || "#64748b"; // Fallback (cinza)

const painelFinal = document.createElement("div");

painelFinal.className = `avaliacao-completa painel-fixo print-visible mt-6 border-2 rounded-xl shadow-lg p-6 text-gray-800 max-w-4xl mx-auto`;

painelFinal.innerHTML = `
  <h2 class="text-xl font-semibold mb-4 text-center text-slate-700">Parecer T√©cnico do Tutor</h2>
  <div class="relative rounded-xl border-l-[6px] p-6 shadow-md bg-white" style="border-color: ${corDominante};">
    <div class="flex justify-between items-start mb-4">
      <h3 class="text-lg font-semibold" style="color: ${corDominante};">
        ${tituloPainel}
      </h3>
      ${parecerTutor.status === 'preliminar' ? `
        <div class="inline-flex items-center px-3 py-1 text-xs rounded bg-[${corDominante}]/10 text-[${corDominante}] font-medium gap-1">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 4a1 1 0 011 1v5a1 1 0 11-2 0V7a1 1 0 011-1zm0 10a1.25 1.25 0 110-2.5 1.25 1.25 0 010 2.5z"/></svg>
          Parecer Preliminar
        </div>
      ` : ''}
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 text-sm text-slate-600 gap-y-1 mb-4">
      <div><strong>Aluno:</strong> ${alunoSel.selectedOptions[0].textContent}</div>
      <div><strong>Aula:</strong> ${aulaSel.selectedOptions[0].textContent}</div>
      <div><strong>Curso:</strong> ${cursoSel.selectedOptions[0].textContent}</div>
      <div><strong>Progresso:</strong> ${diagnostico.percentualAssistido}%</div>
      <div><strong>Dura√ß√£o:</strong> ${diagnostico.duracaoDias} dias</div>
      <div><strong>Sess√µes:</strong> ${diagnostico.totalSessoes}</div>
    </div>

    <p class="text-sm text-slate-700 leading-relaxed mb-4">
      ${parecerTutor.texto}
    </p>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-slate-800 mb-4">
      <div><strong>Nota:</strong> ${avaliacao.nota}</div>
      <div><strong>Conceito:</strong> ${avaliacao.conceito}</div>
      <div><strong>Rubrica:</strong> ${avaliacao.rubrica}</div>
      <div><strong>BNCC:</strong> ${avaliacao.bncc}</div>
      <div class="sm:col-span-2"><strong>Feedback:</strong> ${avaliacao.feedback}</div>
    </div>

    <div class="text-xs text-gray-500 italic border-t pt-3">
      In√≠cio: ${diagnostico.dataInicio.toLocaleDateString('pt-BR')} ${diagnostico.dataInicio.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })} /
      Fim: ${diagnostico.dataFim.toLocaleDateString('pt-BR')} ${diagnostico.dataFim.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })} /
      Sess√µes: ${diagnostico.totalSessoes}
    </div>

    <div class="mt-4 text-left">
      <button onclick="window.print()" class="bg-[${corDominante}] hover:brightness-110 text-white px-4 py-2 rounded-md shadow text-sm transition-all">
        Exportar Parecer em PDF
      </button>
    </div>
  </div>
`;

const blocoDiagnostico = document.getElementById("bloco-diagnostico");
blocoDiagnostico.innerHTML = ''; // Limpa antes de inserir
blocoDiagnostico.appendChild(painelFinal);





  const linhas = bruto.map(r => `
    <div class="bg-white text-gray-800 p-2 rounded-md border border-gray-300 shadow-sm font-mono text-sm hover:bg-gray-100 transition-colors duration-200">
      ${formatar(r.segment.start)} ‚Üí ${formatar(r.segment.end)}
    </div>
  `);
  detalhes.innerHTML = linhas.join('');
});

carregar();



</script>
</body>
</html>
