<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Curso | Academy-Tools</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Nunito:wght@600;700;800&display=swap" rel="stylesheet" />
  <script>
    tailwind.config = {
      darkMode: 'media',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Outfit', 'sans-serif'],
            display: ['Nunito', 'sans-serif']
          },
          colors: {
            primary: {
              50: '#EFF6FF', 100: '#DBEAFE', 200: '#BFDBFE', 300: '#93C5FD',
              400: '#60A5FA', 500: '#3B82F6', 600: '#2563EB', 700: '#1D4ED8', 800: '#1E40AF', 900: '#1E3A8A'
            },
            surface: { 50: '#F8FAFC', 100: '#F1F5F9', 800: '#1E293B', 900: '#0F172A' },
            accent: { 400: '#38BDF8', 500: '#0EA5E9' }
          },
          boxShadow: {
            glow: '0 0 20px rgba(56, 189, 248, 0.3)',
            'glow-lg': '0 0 30px rgba(56, 189, 248, 0.2)'
          },
          borderRadius: {
            xl: '1rem', '2xl': '1.5rem', '3xl': '2rem'
          }
        }
      }
    }
  </script>
</head>
<body class="font-sans bg-gradient-to-br from-surface-50 to-surface-100 text-gray-800 min-h-screen transition-colors duration-300">

  <header class="bg-primary-600 text-white h-14 flex items-center shadow-md">
    <div class="max-w-6xl mx-auto px-4 w-full flex justify-between items-center">
      <h1 class="text-xl font-display font-bold tracking-tight">Academy-Tools</h1>
      <span id="nomeAluno" class="text-sm font-medium text-white/90 truncate"></span>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

      <!-- Lateral -->
      <div class="lg:col-span-1">
        <div class="mb-6">
          <p class="text-sm mb-1"><span>üìä</span> Progresso do curso: <span id="textoProgresso">0%</span></p>
          <div class="w-full h-3 bg-gray-200 rounded">
            <div id="barraProgresso" class="h-3 bg-primary-600 rounded transition-all" style="width: 0%"></div>
          </div>
        </div>
        <h1 id="tituloCurso" class="text-2xl font-bold mb-2">Carregando curso...</h1>
        <p id="descricaoCurso" class="mb-4 text-slate-600 text-sm leading-relaxed"></p>
        <h2 class="font-semibold mb-2 flex items-center gap-2">üìö Aulas</h2>
        <ul id="listaAulas" class="list-none space-y-1 text-sm bg-white p-4 rounded-2xl shadow-lg border border-slate-200"></ul>
      </div>

      <!-- Conte√∫do -->
      <div class="lg:col-span-2">
        <div class="aspect-video w-full rounded-2xl overflow-hidden shadow-lg mb-4">
          <iframe id="videoPlayer" class="w-full h-full" frameborder="0" allowfullscreen></iframe>
        </div>
        <div class="flex flex-wrap items-center justify-between mb-3 gap-2">
          <h3 id="tituloAula" class="text-lg font-semibold">T√≠tulo da Aula</h3>
          <div class="flex items-center gap-2">
            <button id="btnMaterial" class="text-sm bg-white border border-slate-300 rounded px-3 py-2 shadow-sm hover:bg-slate-100 relative">
              üìé Material de Apoio
              <div id="popupMaterial" class="hidden absolute z-10 mt-2 w-64 bg-white border border-gray-300 rounded shadow-md p-4 text-sm text-gray-700">
                <p class="mb-1 font-semibold">Links √∫teis:</p>
                <ul class="list-disc list-inside">
                  <li><a href="#" class="text-primary-600 hover:underline">PDF da aula</a></li>
                  <li><a href="#" class="text-primary-600 hover:underline">Slides</a></li>
                  <li><a href="#" class="text-primary-600 hover:underline">Refer√™ncia externa</a></li>
                </ul>
              </div>
            </button>
            <button id="btnQuiz" disabled class="bg-gray-300 text-gray-500 px-4 py-2 rounded text-sm cursor-not-allowed">
              Fazer Avalia√ß√£o da Aula
            </button>
          </div>
        </div>
        <p class="text-xs text-slate-500">‚öôÔ∏è Progresso salvo automaticamente durante a reprodu√ß√£o</p>
        <p class="text-sm mt-2 text-slate-700 flex gap-2 items-center">
          <span id="progressoTexto" class="text-primary-600 animate-pulse font-medium"></span>
          <span id="recomecarSugestao"></span>
        </p>
      </div>

    </div>
  </main>
  <script>
    const supabase = window.supabase.createClient(
      'https://bkueljjvhijojzcyodvk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrdWVsamp2aGlqb2p6Y3lvZHZrIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0MzUwNTQ4OSwiZXhwIjoyMDU5MDgxNDg5fQ.o-G5KmxoyfQjeNM5e7rbgxpryOHYC9k1OIo9fYzyeYE'
    );

    const url = new URL(location.href);
    const user_id = url.searchParams.get('user_id');
    const course_id = url.searchParams.get('course_id');

    const playerFrame = document.getElementById('videoPlayer');
    const tituloCurso = document.getElementById('tituloCurso');
    const descricaoCurso = document.getElementById('descricaoCurso');
    const listaAulas = document.getElementById('listaAulas');
    const tituloAula = document.getElementById('tituloAula');
    const barraProgresso = document.getElementById('barraProgresso');
    const textoProgresso = document.getElementById('textoProgresso');
    const infoAssistido = document.getElementById('infoAssistido');
    const btnQuiz = document.getElementById('btnQuiz');
    const btnMaterial = document.getElementById('btnMaterial');
    const popupMaterial = document.getElementById('popupMaterial');

    let aulas = [], aulaAtual = null, player = null, interval = null;
    let lastTime = 0, duration = 0;

    async function verificarQuizRespondido(userId, lessonId) {
      const { data, error } = await supabase
        .from('user_quiz_results')
        .select('id')
        .eq('user_id', userId)
        .eq('lesson_id', lessonId)
        .limit(1);

      return !!(data && data.length > 0);
    }

    function getYouTubeId(url) {
      const match = url.match(/(?:v=|\/embed\/|\.be\/)([a-zA-Z0-9_-]{11})/);
      return match ? match[1] : '';
    }

    function atualizarIndicadorLocal(segundos, duracao) {
      const el = document.getElementById("progressoTexto");
      if (!el) {
        console.warn("‚ö†Ô∏è progressoTexto n√£o encontrado no DOM!");
        return;
      }

      const pct = Math.min(100, Math.round((segundos / duracao) * 100));
      el.innerHTML = `<span class="animate-pulse">‚è±Ô∏è</span> ${segundos}s / ${duracao}s üìä ${pct}%`;
    }

    function mostrarNotificacao(texto) {
      const aviso = document.createElement('div');
      aviso.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded shadow-lg z-50 text-sm font-medium transition-opacity';
      aviso.textContent = texto;

      document.body.appendChild(aviso);

      setTimeout(() => {
        aviso.classList.add('opacity-0');
        setTimeout(() => aviso.remove(), 500);
      }, 2500);
    }




    
async function carregarDados() {
    const { data: curso } = await supabase.from('courses').select('*').eq('id', course_id).single();
    tituloCurso.textContent = curso.title;
    descricaoCurso.textContent = curso.description;

    const { data: lista } = await supabase.from('lessons').select('*').eq('course_id', course_id).order('order');
    aulas = lista || [];

    const promises = aulas.map(async (aula) => {
      const { data: progresso } = await supabase.rpc('fn_progresso_por_usuario_e_aula', {
        p_user_id: user_id,
        p_lesson_id: aula.id
      });

      const { data: quizFeito } = await supabase
        .from('user_quiz_results')
        .select('id')
        .eq('user_id', user_id)
        .eq('lesson_id', aula.id)
        .maybeSingle();

      aula.status = progresso?.[0]?.status || 'üö´ N√£o Iniciada';
      aula.quizRespondido = !!quizFeito;
      return aula;
    });

    aulas = await Promise.all(promises);
    listarAulas();
    carregarProgressoCurso();
  }





async function listarAulas() {
  listaAulas.innerHTML = '';

  for (let i = 0; i < aulas.length; i++) {
    const aula = aulas[i];

    // Verifica se quiz foi respondido
    const { data: quizData } = await supabase
      .from('user_quiz_results')
      .select('id')
      .eq('user_id', user_id)
      .eq('lesson_id', aula.id)
      .limit(1);

    const quizRespondido = quizData?.length > 0;

    const podeAcessar = i === 0 || aulas.slice(0, i).every(a =>
      a.status === '‚úî Conclu√≠da' &&
      a.quizRespondido !== false // falsy ou true
    );

    const iconeConclusao = aula.status === '‚úî Conclu√≠da' ? '‚úÖ' : '';
    const iconeQuiz = quizRespondido ? 'üì©' : '';

    const li = document.createElement('li');
    li.className = 'grid grid-cols-[20px_20px_1fr] items-center gap-2 text-gray-700 text-sm';

    li.innerHTML = `
      <span class="text-center">${iconeConclusao}</span>
      <span class="text-center">${iconeQuiz}</span>
      <span>${aula.order}. ${aula.title}</span>
    `;

    if (podeAcessar) {
      li.classList.add('cursor-pointer', 'hover:underline');
      li.onclick = () => selecionarAula(aula);
    } else {
      li.classList.add('opacity-50', 'cursor-not-allowed');
      li.title = 'Conclua as aulas anteriores e envie a avalia√ß√£o para acessar esta.';
    }

    aula.quizRespondido = quizRespondido; // salva no objeto da aula para futuras valida√ß√µes
    listaAulas.appendChild(li);
  }

 if (!aulaAtual && aulas.length > 0) {
    selecionarAula(aulas[0]);
  }
}



    

    async function carregarProgressoCurso() {
      const { data } = await supabase.rpc('fn_progresso_curso_por_usuario', {
        p_user_id: user_id,
        p_course_id: course_id
      });
      if (data?.length > 0) {
        const pct = data[0].percentual_conclusao || 0;
        barraProgresso.style.width = pct + '%';
        textoProgresso.textContent = pct + '%';
      }
    }

    let pontoRetomada = null;






async function selecionarAula(aula) {
  aulaAtual = aula;
  tituloAula.textContent = aula.title;

  const progressoEl = document.getElementById("progressoTexto");
  const sugestaoEl = document.getElementById("recomecarSugestao");

  if (progressoEl) progressoEl.textContent = "";
  if (sugestaoEl) sugestaoEl.innerHTML = "";

  pontoRetomada = null;

  btnQuiz.disabled = true;
  btnQuiz.textContent = "Fazer Avalia√ß√£o da Aula";
  btnQuiz.className = "bg-gray-300 text-gray-500 px-4 py-2 rounded text-sm cursor-not-allowed";
  btnQuiz.onclick = null;

  clearInterval(interval);
  lastTime = 0;

  const { data: progresso } = await supabase.rpc('fn_progresso_por_usuario_e_aula', {
    p_user_id: user_id,
    p_lesson_id: aula.id
  });

  if (progresso?.length > 0) {
    const item = progresso[0];

    // ‚úÖ CASO 1: j√° conclu√≠da ‚Äî encerra aqui
    if (item.status === '‚úî Conclu√≠da') {
      if (progressoEl) progressoEl.textContent = "‚úÖ Aula conclu√≠da";
      if (sugestaoEl) sugestaoEl.innerHTML = "";
      await habilitarQuiz(aula.id);
      return;
    }

    // ‚úÖ CASO 2: verifica√ß√£o manual caso porcentagem seja >= 97%
    if (item.status !== '‚úî Conclu√≠da' && item.segundos_assistidos / item.duracao_total >= 0.97) {
      item.status = '‚úî Conclu√≠da';
      aula.status = '‚úî Conclu√≠da';
      if (progressoEl) progressoEl.textContent = "‚úÖ Aula conclu√≠da";
      if (sugestaoEl) sugestaoEl.innerHTML = "";
      await habilitarQuiz(aula.id);
      listarAulas();
      carregarProgressoCurso();
      return;
    }

    // ‚úÖ Caso ainda n√£o tenha finalizado ‚Äî exibe progresso e sugest√£o de retomada
    atualizarIndicadorLocal(item.segundos_assistidos, item.duracao_total);
    pontoRetomada = Math.max(0, item.segundos_assistidos - 15);

    const minutos = Math.floor(pontoRetomada / 60);
    const segundos = pontoRetomada % 60;
    const retomadaLabel = `${minutos}m${segundos.toString().padStart(2, '0')}s`;

    const link = document.createElement('span');
    link.className = 'text-sm text-blue-600 underline cursor-pointer ml-2 hover:text-blue-800 transition';
    link.textContent = `üîÑ Retomar a partir de ${retomadaLabel}`;

    link.onclick = async () => {
      if (!player || typeof player.seekTo !== 'function') return;
      mostrarNotificacao(`‚è© Pulando para ${retomadaLabel}...`);
      try {
        player.seekTo(pontoRetomada, true);
        setTimeout(() => {
          player.playVideo?.();
          sugestaoEl.innerHTML = "";
        }, 500);
      } catch (err) {
        console.error('‚ùå Erro ao retomar:', err);
        mostrarNotificacao('Erro ao tentar retomar o v√≠deo');
      }
    };

    if (sugestaoEl) {
      sugestaoEl.innerHTML = "";
      sugestaoEl.appendChild(link);
    }

  } else {
    // Nenhum progresso salvo ainda
    atualizarIndicadorLocal(0, aula.duration);
    pontoRetomada = null;
  }

  initPlayer();
}







    

    function loadYouTubeAPI() {
      return new Promise(resolve => {
        if (window.YT && window.YT.Player) return resolve();
        window.onYouTubeIframeAPIReady = resolve;
      });
    }

    function initPlayer() {
      const videoId = getYouTubeId(aulaAtual.youtube_url);
      playerFrame.src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&origin=${location.origin}`;

      loadYouTubeAPI().then(() => {
        player = new YT.Player(playerFrame, {
          events: { onReady: onPlayerReady }
        });
      });
    }

    async function onPlayerReady() {
      console.log('üé¨ Player pronto, iniciando monitoramento...');

      if (!player || typeof player.getDuration !== 'function') {
        console.warn('‚ö†Ô∏è Player inv√°lido, tentando novamente...');
        setTimeout(onPlayerReady, 300);
        return;
      }

      duration = player.getDuration();
      console.log('‚è±Ô∏è Dura√ß√£o total do v√≠deo:', duration);

      if (pontoRetomada !== null) {
        console.log('‚è© Retomando do ponto:', pontoRetomada);
        player.seekTo(pontoRetomada, true);
        player.playVideo?.();
      }

      interval = setInterval(trackProgress, 5000);
    }
    let maiorTempoVisualizado = 0;



async function trackProgress() {
  console.log("üì° Executando trackProgress em:", new Date().toISOString());

  if (!player || typeof player.getCurrentTime !== 'function') {
    console.warn('üö´ Player n√£o est√° pronto ou inv√°lido');
    return;
  }

  const state = player.getPlayerState();
  if (state !== YT.PlayerState.PLAYING) {
    console.log('‚è∏Ô∏è V√≠deo n√£o est√° tocando.');
    return;
  }

  const tempoAtual = Math.floor(player.getCurrentTime());
  const diff = tempoAtual - lastTime;

  if (tempoAtual > maiorTempoVisualizado) {
    maiorTempoVisualizado = tempoAtual;
    atualizarIndicadorLocal(maiorTempoVisualizado, duration);
  }

  if (diff <= 0 || diff > 30) {
    console.warn('‚õî Ignorando salto inv√°lido.', { tempoAtual, lastTime });
    return;
  }

  const segmento = {
    user_id,
    course_id,
    lesson_id: aulaAtual.id,
    duration: Math.floor(duration),
    segment: { start: lastTime, end: tempoAtual }
  };

  console.log("üì§ Segmento enviado ao Supabase:", segmento);

  const { error: insertError } = await supabase
    .from('progress_segments')
    .insert(segmento);

  if (insertError) {
    console.error('‚ùå Erro ao salvar segmento no Supabase:', insertError);
    return;
  }

  lastTime = tempoAtual;

  const { data: progressoAtualizado, error: erroProgresso } = await supabase.rpc('fn_progresso_por_usuario_e_aula', {
    p_user_id: user_id,
    p_lesson_id: aulaAtual.id
  });

  if (erroProgresso) {
    console.error('‚ùå Erro ao consultar progresso atualizado:', erroProgresso);
    return;
  }

  if (progressoAtualizado?.length > 0) {
    const item = progressoAtualizado[0];
    aulaAtual.status = item.status;

    if (item.status === '‚úî Conclu√≠da') {
      document.getElementById("progressoTexto").textContent = "‚úÖ Aula conclu√≠da";
      document.getElementById("recomecarSugestao").innerHTML = "";
      await habilitarQuiz(aulaAtual.id);

      // üîÑ Atualizar a pr√≥xima aula dinamicamente
      const indexAtual = aulas.findIndex(a => a.id === aulaAtual.id);
      const proxima = aulas[indexAtual + 1];

      if (proxima && proxima.status !== '‚úî Conclu√≠da') {
        console.log('üîì Desbloqueando pr√≥xima aula:', proxima.title);
        proxima.status = 'üîì Desbloqueada';
        listarAulas();
      }
    }

    listarAulas();
    carregarProgressoCurso();
  }
}








    

    btnMaterial.addEventListener('click', () => popupMaterial.classList.toggle('hidden'));

    window.addEventListener('click', (e) => {
      if (!btnMaterial.contains(e.target) && !popupMaterial.contains(e.target)) {
        popupMaterial.classList.add('hidden');
      }
    });

    async function habilitarQuiz(aulaId) {
      const jaFez = await verificarQuizRespondido(user_id, aulaId);

      console.log("üìã Verificando se quiz j√° foi respondido...");
      console.log("User ID:", user_id, "| Aula ID:", aulaId);
      console.log("Resultado Supabase:", jaFez);

if (jaFez) {
  btnQuiz.disabled = true;
  btnQuiz.textContent = "‚úÖ Avalia√ß√£o enviada";
  btnQuiz.className = "bg-gray-200 text-gray-600 px-4 py-2 rounded text-sm cursor-not-allowed";
  btnQuiz.title = "Voc√™ j√° respondeu esta avalia√ß√£o";
  btnQuiz.onclick = null;

  // ‚úÖ Marcar que o quiz foi respondido (para os √≠cones)
  const index = aulas.findIndex(a => a.id === aulaId);
  if (index !== -1) {
    aulas[index].quizRespondido = true;
  }

  listarAulas(); // re-renderiza com o novo √≠cone
  return;
}

      btnQuiz.disabled = false;
      btnQuiz.textContent = "üìù Fazer Avalia√ß√£o da Aula";
      btnQuiz.className = "bg-blue-600 text-white hover:bg-blue-700 px-4 py-2 rounded text-sm transition";
      btnQuiz.title = "Abrir avalia√ß√£o desta aula";

      btnQuiz.onclick = () => {
        const quizContainer = document.createElement('div');
        quizContainer.className = "fixed inset-0 bg-black/50 flex items-center justify-center z-50";

        quizContainer.innerHTML = `
          <div class="bg-white w-full max-w-2xl h-[90vh] p-4 rounded-xl shadow-xl relative border border-slate-200 overflow-hidden">
            <button onclick="this.parentElement.parentElement.remove()" class="absolute top-3 right-4 text-gray-500 hover:text-red-600 text-xl">&times;</button>
            <iframe src="quiz.html?user_id=${user_id}&lesson_id=${aulaId}" class="w-full h-full rounded-lg border border-slate-200" frameborder="0"></iframe>
          </div>
        `;

        document.body.appendChild(quizContainer);
      };
    }

    document.addEventListener("DOMContentLoaded", () => {
     
      
// Buscar nome do aluno
async function carregarNomeAluno() {
  const { data: user } = await supabase.from('users').select('name').eq('id', user_id).single();
  if (user) {
    document.getElementById('nomeAluno').textContent = user.name;
  }
}

      carregarDados();
carregarNomeAluno();

    });
  </script>
</body>
</html>
